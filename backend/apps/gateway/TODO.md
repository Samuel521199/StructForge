# Gateway 系统待完善功能清单

## 📋 功能完善优先级

### 🔴 高优先级（核心功能缺失）

#### 1. **限流中间件** ⚠️ 配置已存在但未实现
- **状态**: 配置结构已定义，但实际限流逻辑未实现
- **位置**: `backend/apps/gateway/internal/router/router.go` 中的 `RateLimit` 配置
- **需要实现**:
  - 基于 Token Bucket 或 Sliding Window 算法的限流器
  - 支持按路由配置的 QPS 和 Burst
  - 支持 IP 级别、用户级别、API 级别的限流
  - 集成 Redis 实现分布式限流（可选）
- **影响**: 无法防止系统过载和恶意请求

#### 2. **请求重试机制** ⚠️ 配置已存在但未实现
- **状态**: `Retries` 配置字段已定义，但 `Forward` 方法中未实现重试逻辑
- **位置**: `backend/apps/gateway/internal/router/router.go:225-233`
- **需要实现**:
  - 基于配置的 `retries` 参数实现重试
  - 支持指数退避策略
  - 区分可重试错误（网络错误、超时）和不可重试错误（4xx）
  - 记录重试日志
- **影响**: 网络抖动时无法自动恢复，影响系统可靠性

#### 3. **正则路由匹配** ⚠️ TODO 标记
- **状态**: 代码中有 TODO 注释，但未实现
- **位置**: `backend/apps/gateway/internal/router/router.go:137-139`
- **需要实现**:
  - 使用 `regexp` 包实现正则表达式匹配
  - 支持路径参数提取（如 `/api/v1/users/{id}`）
  - 性能优化（预编译正则表达式）
- **影响**: 无法支持复杂的路由规则

#### 4. **统一错误处理和响应格式**
- **状态**: 当前错误响应格式不统一
- **位置**: `backend/apps/gateway/internal/handler/gateway.go`
- **需要实现**:
  - 定义统一的响应结构体
  - 统一错误码和错误消息
  - 错误响应格式化
  - 支持国际化错误消息（可选）
- **影响**: 客户端难以统一处理错误

### 🟡 中优先级（功能增强）

#### 5. **CORS 支持**
- **状态**: 文档中提到但未实现
- **需要实现**:
  - CORS 中间件
  - 支持配置允许的源、方法、头部
  - 支持预检请求（OPTIONS）处理
- **影响**: 前端跨域请求可能失败

#### 6. **请求/响应日志记录**
- **状态**: 只有基本日志，缺少详细请求/响应日志
- **需要实现**:
  - 记录请求方法、路径、参数、请求头
  - 记录响应状态码、响应时间、响应大小
  - 支持日志级别控制（敏感信息脱敏）
  - 支持结构化日志输出
- **影响**: 难以排查问题和监控系统

#### 7. **动态服务发现**
- **状态**: 接口已定义，但只有静态实现
- **位置**: `backend/apps/gateway/internal/router/discovery/discovery.go`
- **需要实现**:
  - Nacos 服务发现集成
  - Consul 服务发现集成（可选）
  - 服务实例健康检查自动更新
  - 服务实例变化监听和通知
- **影响**: 无法自动发现和更新服务实例

#### 8. **健康检查端点**
- **状态**: 健康检查器已定义但逻辑未实现
- **位置**: `backend/apps/gateway/internal/router/discovery/discovery.go:185-233`
- **需要实现**:
  - 定期检查服务实例健康状态
  - HTTP GET /health 端点检查
  - 自动标记不健康的实例
  - 健康检查失败重试机制
- **影响**: 无法自动检测和隔离不健康的服务实例

### 🟢 低优先级（高级功能）

#### 9. **熔断器（Circuit Breaker）**
- **状态**: 文档中提到但未实现
- **需要实现**:
  - 基于错误率的熔断逻辑
  - 支持半开状态（Half-Open）
  - 自动恢复机制
  - 熔断状态监控
- **影响**: 无法防止级联故障

#### 10. **请求/响应转换**
- **状态**: 未实现
- **需要实现**:
  - 请求体转换（JSON → Protobuf）
  - 响应体转换（Protobuf → JSON）
  - 请求头转换
  - 路径参数提取和注入
- **影响**: 无法支持 gRPC 服务代理

#### 11. **WebSocket 代理**
- **状态**: 文档中提到但未实现
- **需要实现**:
  - WebSocket 连接升级
  - 双向消息转发
  - 连接管理
  - 心跳检测
- **影响**: 无法支持实时通信场景

#### 12. **监控和指标收集**
- **状态**: 未实现
- **需要实现**:
  - Prometheus 指标导出
  - 请求 QPS、响应时间、错误率统计
  - 服务实例健康状态指标
  - 自定义业务指标
- **影响**: 无法进行系统监控和告警

#### 13. **请求缓存**
- **状态**: 未实现
- **需要实现**:
  - 基于 HTTP 方法的缓存策略（GET 请求）
  - 缓存键生成（路径 + 查询参数）
  - 缓存过期时间配置
  - 缓存失效机制
- **影响**: 无法减少后端服务压力

#### 14. **灰度发布支持**
- **状态**: 未实现
- **需要实现**:
  - 基于流量比例的灰度路由
  - 基于用户ID的灰度路由
  - 基于请求头的灰度路由
  - 灰度规则配置
- **影响**: 无法进行平滑发布

## 🔍 代码质量问题

### 1. **错误处理不完善**
- `Forward` 方法中错误处理过于简单
- 缺少错误分类（网络错误、超时错误、业务错误）
- 错误信息不够详细

### 2. **缺少单元测试**
- 路由匹配逻辑未测试
- 负载均衡逻辑未测试
- 服务发现逻辑未测试

### 3. **配置验证**
- 缺少路由配置验证（路径格式、服务名称等）
- 缺少服务实例配置验证（端口范围、权重范围等）

### 4. **性能优化**
- HTTP 客户端连接池配置可以优化
- 路由匹配可以优化（使用 Trie 树）
- 限流器可以使用更高效的算法

## 📝 配置完善

### 1. **配置文件结构**
- 当前配置缺少一些高级选项（如 CORS、缓存策略）
- 需要添加配置验证和默认值

### 2. **配置热更新**
- 支持动态更新路由配置（通过 Nacos 或 API）
- 支持配置版本管理

## 🎯 建议的完善顺序

### Phase 1: 核心功能（1-2周）
1. ✅ 限流中间件
2. ✅ 请求重试机制
3. ✅ 正则路由匹配
4. ✅ 统一错误处理

### Phase 2: 功能增强（1-2周）
5. ✅ CORS 支持
6. ✅ 请求/响应日志
7. ✅ 健康检查端点
8. ✅ 动态服务发现（Nacos）

### Phase 3: 高级功能（2-4周）
9. ✅ 熔断器
10. ✅ 监控指标
11. ✅ 请求缓存
12. ✅ WebSocket 代理

## 📊 当前完成度

- **基础架构**: ✅ 100% (路由系统、服务发现接口、负载均衡)
- **核心功能**: ✅ 100% (路由转发 ✅、认证 ✅、限流 ✅、重试 ✅、正则匹配 ✅、统一错误处理 ✅)
- **功能增强**: ✅ 100% (CORS ✅、请求/响应日志 ✅、健康检查 ✅、动态服务发现 ✅、配置化前端地址 ✅)
- **高级功能**: ⚠️ 0% (熔断器、监控、缓存、WebSocket等)
- **代码质量**: ⚠️ 80% (缺少测试、错误处理已完善)

## 🔗 相关文件

- 路由系统: `backend/apps/gateway/internal/router/router.go`
- 处理器: `backend/apps/gateway/internal/handler/gateway.go`
- 配置: `backend/configs/local/gateway.yaml`
- 文档: `backend/apps/gateway/README.md`, `backend/apps/gateway/IMPLEMENTATION.md`

