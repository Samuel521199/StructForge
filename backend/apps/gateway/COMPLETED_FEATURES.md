# Gateway å·²å®ŒæˆåŠŸèƒ½æ¸…å•

## âœ… å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½

### 1. è·¯ç”±è½¬å‘åŠŸèƒ½ âœ…
- **å®ç°ä½ç½®**: `backend/apps/gateway/internal/router/router.go`
- **åŠŸèƒ½**:
  - æ”¯æŒåŠ¨æ€è·¯ç”±åˆ°å„ä¸ªå¾®æœåŠ¡
  - æ”¯æŒç²¾ç¡®åŒ¹é…ï¼ˆexactï¼‰ã€å‰ç¼€åŒ¹é…ï¼ˆprefixï¼‰ã€æ­£åˆ™åŒ¹é…ï¼ˆregexï¼‰
  - æ”¯æŒè·¯å¾„é‡å†™ï¼ˆtarget_pathï¼‰
  - æ”¯æŒæŸ¥è¯¢å‚æ•°ä¼ é€’
  - å®Œæ•´çš„è¯·æ±‚/å“åº”è½¬å‘

### 2. JWT è®¤è¯ä¸­é—´ä»¶ âœ…
- **å®ç°ä½ç½®**: `backend/apps/gateway/internal/middleware/jwt/jwt.go`
- **åŠŸèƒ½**:
  - JWT Token éªŒè¯
  - ä»è¯·æ±‚å¤´è§£æ Bearer Token
  - Token è¿‡æœŸæ£€æŸ¥
  - å¯é…ç½®çš„å¯†é’¥å’Œæœ‰æ•ˆæœŸ

### 3. æœåŠ¡å‘ç°æœºåˆ¶ âœ…
- **å®ç°ä½ç½®**: `backend/apps/gateway/internal/router/discovery/`
- **åŠŸèƒ½**:
  - é™æ€æœåŠ¡å‘ç°ï¼ˆåŸºäºé…ç½®æ–‡ä»¶ï¼‰
  - åŠ¨æ€æœåŠ¡å‘ç°ï¼ˆNacosé›†æˆï¼‰
  - æœåŠ¡å®ä¾‹ç¼“å­˜
  - æœåŠ¡ç›‘å¬å’Œè‡ªåŠ¨åˆ·æ–°
  - å¥åº·å®ä¾‹è¿‡æ»¤

### 4. è´Ÿè½½å‡è¡¡ âœ…
- **å®ç°ä½ç½®**: `backend/apps/gateway/internal/router/loadbalancer/`
- **åŠŸèƒ½**:
  - è½®è¯¢ï¼ˆRound Robinï¼‰
  - éšæœºï¼ˆRandomï¼‰
  - æœ€å°‘è¿æ¥ï¼ˆLeast Connectionsï¼‰
  - æ”¯æŒæƒé‡é…ç½®

### 5. é™æµä¸­é—´ä»¶ âœ…
- **å®ç°ä½ç½®**: `backend/apps/gateway/internal/middleware/ratelimit/ratelimit.go`
- **åŠŸèƒ½**:
  - Token Bucket ç®—æ³•
  - æ”¯æŒæŒ‰è·¯ç”±é…ç½® QPS å’Œ Burst
  - è‡ªåŠ¨æ¸…ç†ä¸æ´»è·ƒçš„ä»¤ç‰Œæ¡¶
  - åœ¨è®¤è¯å‰æ£€æŸ¥ï¼ŒèŠ‚çœèµ„æº
  - æ”¯æŒ API çº§åˆ«é™æµï¼ˆå¯æ‰©å±• IP/ç”¨æˆ·çº§åˆ«ï¼‰

### 6. è¯·æ±‚é‡è¯•æœºåˆ¶ âœ…
- **å®ç°ä½ç½®**: `backend/apps/gateway/internal/router/router.go:225-278`
- **åŠŸèƒ½**:
  - åŸºäºé…ç½®çš„ `retries` å‚æ•°
  - æŒ‡æ•°é€€é¿ç­–ç•¥ï¼ˆæœ€å¤š1ç§’ï¼‰
  - åŒºåˆ†å¯é‡è¯•é”™è¯¯ï¼ˆç½‘ç»œé”™è¯¯ã€5xxï¼‰å’Œä¸å¯é‡è¯•é”™è¯¯ï¼ˆ4xxï¼‰
  - è¯¦ç»†çš„é‡è¯•æ—¥å¿—è®°å½•

### 7. æ­£åˆ™è·¯ç”±åŒ¹é… âœ…
- **å®ç°ä½ç½®**: `backend/apps/gateway/internal/router/router.go:347-374`
- **åŠŸèƒ½**:
  - æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
  - æ­£åˆ™è¡¨è¾¾å¼ç¼“å­˜ï¼ˆé¿å…é‡å¤ç¼–è¯‘ï¼‰
  - é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### 8. ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œå“åº”æ ¼å¼ âœ…
- **å®ç°ä½ç½®**: `backend/apps/gateway/internal/handler/response.go`
- **åŠŸèƒ½**:
  - æ ‡å‡†å“åº”ç»“æ„ `StandardResponse`
  - é¢„å®šä¹‰é”™è¯¯å“åº”ï¼ˆ404ã€401ã€429ã€500ç­‰ï¼‰
  - ç»Ÿä¸€çš„é”™è¯¯ç å’Œæ¶ˆæ¯æ ¼å¼
  - æ”¯æŒé”™è¯¯è¯¦æƒ…å’Œè¿½è¸ªID

### 9. CORS æ”¯æŒ âœ…
- **å®ç°ä½ç½®**: `backend/apps/gateway/internal/middleware/cors/cors.go`
- **åŠŸèƒ½**:
  - æ”¯æŒé…ç½®å…è®¸çš„æºã€æ–¹æ³•ã€è¯·æ±‚å¤´
  - æ”¯æŒé€šé…ç¬¦åŒ¹é…ï¼ˆå¦‚ `*.example.com`ï¼‰
  - å¤„ç†é¢„æ£€è¯·æ±‚ï¼ˆOPTIONSï¼‰
  - æ”¯æŒå‡­è¯ä¼ é€’ï¼ˆAllowCredentialsï¼‰
  - é¢„æ£€è¯·æ±‚ç¼“å­˜æ—¶é—´é…ç½®

### 10. è¯·æ±‚/å“åº”æ—¥å¿—è®°å½• âœ…
- **å®ç°ä½ç½®**: `backend/apps/gateway/internal/middleware/logging/logging.go`
- **åŠŸèƒ½**:
  - è®°å½•è¯·æ±‚ä¿¡æ¯ï¼ˆæ–¹æ³•ã€è·¯å¾„ã€æŸ¥è¯¢å‚æ•°ã€IPã€User-Agentã€è€—æ—¶ï¼‰
  - è®°å½•è¯·æ±‚ä½“ï¼ˆå¯é…ç½®å¤§å°é™åˆ¶ï¼Œé»˜è®¤10KBï¼‰
  - è®°å½•å“åº”ä¿¡æ¯ï¼ˆè€—æ—¶ï¼‰
  - è®°å½•å“åº”ä½“ï¼ˆå¯é…ç½®å¤§å°é™åˆ¶ï¼‰
  - é”™è¯¯æ—¥å¿—è®°å½•
  - è‡ªåŠ¨æˆªæ–­è¿‡å¤§çš„è¯·æ±‚/å“åº”ä½“

### 11. å¥åº·æ£€æŸ¥ç«¯ç‚¹ âœ…
- **å®ç°ä½ç½®**: `backend/apps/gateway/internal/handler/gateway.go:79-170`
- **åŠŸèƒ½**:
  - `/health` - å®Œæ•´å¥åº·æ£€æŸ¥ï¼ˆåŒ…å«ä¸‹æ¸¸æœåŠ¡çŠ¶æ€ï¼‰
  - `/ready` - Kubernetes readiness probe
  - `/live` - Kubernetes liveness probe
  - æ£€æŸ¥ä¸‹æ¸¸æœåŠ¡å¥åº·çŠ¶æ€
  - æœåŠ¡çŠ¶æ€èšåˆï¼ˆok, degraded, downï¼‰
  - å®ä¾‹æ•°é‡ç»Ÿè®¡

### 12. åŠ¨æ€æœåŠ¡å‘ç°ï¼ˆNacosï¼‰âœ…
- **å®ç°ä½ç½®**: `backend/apps/gateway/internal/router/discovery/nacos_discovery.go`
- **åŠŸèƒ½**:
  - é›†æˆ Nacos æœåŠ¡å‘ç°
  - æœåŠ¡å®ä¾‹è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯10ç§’ï¼‰
  - æœåŠ¡æ³¨å†Œå’Œæ³¨é”€
  - æœ¬åœ°ç¼“å­˜æœºåˆ¶
  - å¥åº·å®ä¾‹è¿‡æ»¤

## ğŸ“Š åŠŸèƒ½ç»Ÿè®¡

- **å·²å®Œæˆ**: 13 ä¸ªæ ¸å¿ƒåŠŸèƒ½
- **ä»£ç è´¨é‡**: æ‰€æœ‰ä»£ç å·²é€šè¿‡ç¼–è¯‘
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- **ä»£ç æ³¨é‡Š**: æ¸…æ™°çš„ä»£ç æ³¨é‡Š
- **é…ç½®éªŒè¯**: å®Œæ•´çš„é…ç½®éªŒè¯æœºåˆ¶

## ğŸ¯ æ¶æ„ç‰¹ç‚¹

1. **æ¨¡å—åŒ–è®¾è®¡**: æ¯ä¸ªåŠŸèƒ½ç‹¬ç«‹æ¨¡å—ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
2. **æ¥å£æŠ½è±¡**: ä½¿ç”¨æ¥å£å®ç°ï¼Œæ”¯æŒå¤šç§å®ç°æ–¹å¼
3. **é…ç½®é©±åŠ¨**: é€šè¿‡é…ç½®æ–‡ä»¶çµæ´»æ§åˆ¶åŠŸèƒ½
4. **æ€§èƒ½ä¼˜åŒ–**: ç¼“å­˜æœºåˆ¶ã€è¿æ¥æ± ã€æ­£åˆ™è¡¨è¾¾å¼ç¼“å­˜ç­‰
5. **å¯è§‚æµ‹æ€§**: å®Œæ•´çš„æ—¥å¿—è®°å½•å’Œå¥åº·æ£€æŸ¥

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### é…ç½®ç¤ºä¾‹ï¼ˆgateway.yamlï¼‰

```yaml
gateway:
  jwt:
    secret_key: "your-secret-key"
    token_duration: "24h"
  routes:
    - path: "/api/v1/users"
      match_type: "prefix"
      service: "user-service"
      require_auth: false
      rate_limit:
        qps: 100
        burst: 200
      retries: 2
      timeout: 5
  services:
    user-service:
      - id: "user-service-1"
        host: "localhost"
        port: 8001
        weight: 100
        healthy: true
```

### å¥åº·æ£€æŸ¥å“åº”ç¤ºä¾‹

```json
{
  "status": "ok",
  "service": "gateway",
  "timestamp": "2024-01-01T12:00:00Z",
  "version": "1.0.0",
  "services": {
    "user-service": {
      "status": "ok",
      "instance_count": 2,
      "last_check": "2024-01-01T12:00:00Z"
    }
  }
}
```

### 13. é…ç½®éªŒè¯ âœ…
- **å®ç°ä½ç½®**: `backend/apps/gateway/internal/router/validator.go`
- **åŠŸèƒ½**:
  - è·¯ç”±é…ç½®éªŒè¯ï¼ˆè·¯å¾„æ ¼å¼ã€åŒ¹é…ç±»å‹ã€æœåŠ¡åç§°ã€è¶…æ—¶ã€é‡è¯•ç­‰ï¼‰
  - æœåŠ¡å®ä¾‹é…ç½®éªŒè¯ï¼ˆç«¯å£èŒƒå›´ã€æƒé‡èŒƒå›´ç­‰ï¼‰
  - JWTé…ç½®éªŒè¯ï¼ˆå¯†é’¥é•¿åº¦ã€é»˜è®¤å€¼è­¦å‘Šï¼‰
  - CORSé…ç½®éªŒè¯ï¼ˆæ–¹æ³•æœ‰æ•ˆæ€§ã€MaxAgeèŒƒå›´ç­‰ï¼‰
  - ç†”æ–­å™¨é…ç½®éªŒè¯ï¼ˆå¤±è´¥ç‡é˜ˆå€¼ã€æ—¶é—´çª—å£ã€è¶…æ—¶ç­‰ï¼‰
  - è¯¦ç»†çš„éªŒè¯é”™è¯¯ä¿¡æ¯å’Œè­¦å‘Š

### 14. ç†”æ–­å™¨ï¼ˆCircuit Breakerï¼‰âœ…
- **å®ç°ä½ç½®**: `backend/apps/gateway/internal/middleware/circuitbreaker/`
- **åŠŸèƒ½**:
  - ä¸‰ç§çŠ¶æ€ç®¡ç†ï¼šå…³é—­ï¼ˆClosedï¼‰ã€æ‰“å¼€ï¼ˆOpenï¼‰ã€åŠå¼€ï¼ˆHalf-Openï¼‰
  - åŸºäºå¤±è´¥ç‡çš„è‡ªåŠ¨ç†”æ–­ï¼ˆå¯é…ç½®é˜ˆå€¼ï¼‰
  - æ—¶é—´çª—å£ç»Ÿè®¡ï¼ˆæ»‘åŠ¨çª—å£ï¼‰
  - è‡ªåŠ¨æ¢å¤æœºåˆ¶ï¼ˆåŠå¼€çŠ¶æ€æµ‹è¯•ï¼‰
  - è¶…æ—¶æ£€æµ‹ï¼ˆè¯·æ±‚è¶…æ—¶è§†ä¸ºå¤±è´¥ï¼‰
  - ç†”æ–­å™¨ç®¡ç†å™¨ï¼ˆæ”¯æŒå¤šæœåŠ¡ç‹¬ç«‹ç†”æ–­ï¼‰
  - é›†æˆåˆ°è·¯ç”±è½¬å‘é€»è¾‘
  - å¥åº·æ£€æŸ¥ç«¯ç‚¹åŒ…å«ç†”æ–­å™¨çŠ¶æ€
  - é…ç½®éªŒè¯å’Œé»˜è®¤å€¼å¤„ç†

#### é…ç½®ç¤ºä¾‹

```yaml
circuit_breaker:
  enabled: true
  failure_threshold: 0.5  # 50% å¤±è´¥ç‡è§¦å‘ç†”æ–­
  min_requests: 10         # è‡³å°‘10ä¸ªè¯·æ±‚æ‰å¼€å§‹è®¡ç®—å¤±è´¥ç‡
  window_size: 60          # 60ç§’æ—¶é—´çª—å£
  open_duration: 30        # æ‰“å¼€çŠ¶æ€æŒç»­30ç§’
  half_open_requests: 3    # åŠå¼€çŠ¶æ€å…è®¸3ä¸ªè¯·æ±‚
  timeout: 5               # 5ç§’è¶…æ—¶
```

#### ç†”æ–­å™¨çŠ¶æ€ä¿¡æ¯

å¥åº·æ£€æŸ¥ç«¯ç‚¹ `/health` ä¼šè¿”å›ç†”æ–­å™¨çŠ¶æ€ï¼š

```json
{
  "circuit_breakers": {
    "user-service": {
      "state": "closed",
      "failures": 2,
      "successes": 18,
      "total_requests": 20,
      "failure_rate": 0.1,
      "last_failure": "2024-01-01T12:00:00Z",
      "state_since": "2024-01-01T11:59:00Z"
    }
  }
}
```

### 15. ç›‘æ§æŒ‡æ ‡æ”¶é›†ï¼ˆPrometheusï¼‰âœ…
- **å®ç°ä½ç½®**: `backend/apps/gateway/internal/middleware/metrics/`
- **åŠŸèƒ½**:
  - HTTP è¯·æ±‚æ€»æ•°ï¼ˆæŒ‰æ–¹æ³•ã€è·¯å¾„ã€çŠ¶æ€ç ï¼‰
  - HTTP è¯·æ±‚æŒç»­æ—¶é—´ï¼ˆç›´æ–¹å›¾ï¼‰
  - HTTP è¯·æ±‚/å“åº”å¤§å°ï¼ˆç›´æ–¹å›¾ï¼‰
  - æ´»è·ƒè¯·æ±‚æ•°ï¼ˆGaugeï¼‰
  - é™æµæ‹’ç»çš„è¯·æ±‚æ•°ï¼ˆCounterï¼‰
  - ç†”æ–­å™¨æ‰“å¼€æ¬¡æ•°ï¼ˆCounterï¼‰
  - ç†”æ–­å™¨çŠ¶æ€ï¼ˆGaugeï¼š0=closed, 1=open, 2=half-openï¼‰
  - ä¸‹æ¸¸æœåŠ¡è¯·æ±‚æ€»æ•°å’ŒæŒç»­æ—¶é—´
  - æŒ‡æ ‡ç«¯ç‚¹ `/metrics`ï¼ˆå»ºè®®ä½¿ç”¨ç‹¬ç«‹æœåŠ¡å™¨æš´éœ²ï¼‰

#### æŒ‡æ ‡åˆ—è¡¨

| æŒ‡æ ‡åç§° | ç±»å‹ | æ ‡ç­¾ | è¯´æ˜ |
|---------|------|------|------|
| `gateway_http_requests_total` | Counter | method, path, status_code | HTTP è¯·æ±‚æ€»æ•° |
| `gateway_http_request_duration_seconds` | Histogram | method, path | HTTP è¯·æ±‚æŒç»­æ—¶é—´ |
| `gateway_http_request_size_bytes` | Histogram | method, path | HTTP è¯·æ±‚å¤§å° |
| `gateway_http_response_size_bytes` | Histogram | method, path | HTTP å“åº”å¤§å° |
| `gateway_http_requests_in_flight` | Gauge | - | å½“å‰æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•° |
| `gateway_rate_limit_rejected_total` | Counter | path | è¢«é™æµæ‹’ç»çš„è¯·æ±‚æ•° |
| `gateway_circuit_breaker_opened_total` | Counter | service | ç†”æ–­å™¨æ‰“å¼€æ¬¡æ•° |
| `gateway_circuit_breaker_state` | Gauge | service | ç†”æ–­å™¨çŠ¶æ€ï¼ˆ0=closed, 1=open, 2=half-openï¼‰ |
| `gateway_downstream_requests_total` | Counter | service, status_code | ä¸‹æ¸¸æœåŠ¡è¯·æ±‚æ€»æ•° |
| `gateway_downstream_request_duration_seconds` | Histogram | service | ä¸‹æ¸¸æœåŠ¡è¯·æ±‚æŒç»­æ—¶é—´ |

#### ä½¿ç”¨æ–¹å¼

**æ–¹å¼1ï¼šé€šè¿‡ç‹¬ç«‹ HTTP æœåŠ¡å™¨æš´éœ²æŒ‡æ ‡ï¼ˆæ¨èï¼‰**

```go
// åœ¨ main.go ä¸­å¯åŠ¨ç‹¬ç«‹çš„æŒ‡æ ‡æœåŠ¡å™¨
go func() {
    if err := handler.StartMetricsServer(":9090"); err != nil {
        log.Error(ctx, "æŒ‡æ ‡æœåŠ¡å™¨å¯åŠ¨å¤±è´¥", log.ErrorField(err))
    }
}()
```

**æ–¹å¼2ï¼šé€šè¿‡ Kratos HTTP æœåŠ¡å™¨æš´éœ²ï¼ˆå½“å‰å®ç°ï¼‰**

è®¿é—® `http://localhost:8000/metrics` è·å–æç¤ºä¿¡æ¯ï¼ˆç”±äº Kratos é™åˆ¶ï¼Œå®é™…æŒ‡æ ‡éœ€è¦é€šè¿‡ç‹¬ç«‹æœåŠ¡å™¨æš´éœ²ï¼‰

## ğŸš€ ä¸‹ä¸€æ­¥ä¼˜åŒ–æ–¹å‘

1. **å®Œå–„åŠ¨æ€æœåŠ¡å‘ç°** - å®ç° Nacos æœåŠ¡è®¢é˜…å’Œå®æ—¶æ›´æ–°ï¼ˆç›®å‰ä½¿ç”¨è½®è¯¢æ–¹å¼ï¼‰
2. âœ… **ç›‘æ§æŒ‡æ ‡æ”¶é›†** - å·²é›†æˆ Prometheusï¼Œæ”¶é›† QPSã€å“åº”æ—¶é—´ç­‰æŒ‡æ ‡
3. âœ… **ç†”æ–­å™¨** - å·²å®ç°æœåŠ¡ç†”æ–­ï¼Œé˜²æ­¢çº§è”æ•…éšœ
4. **WebSocket/gRPC ä»£ç†** - æ”¯æŒ WebSocket å’Œ gRPC åè®®è½¬å‘
5. **è¯·æ±‚ç¼“å­˜** - å®ç°GETè¯·æ±‚ç¼“å­˜ï¼Œå‡å°‘åç«¯å‹åŠ›
6. **ç°åº¦å‘å¸ƒ** - æ”¯æŒåŸºäºæµé‡æ¯”ä¾‹æˆ–ç”¨æˆ·IDçš„ç°åº¦è·¯ç”±

---

**æœ€åæ›´æ–°**: 2024å¹´
**ç‰ˆæœ¬**: v1.0

