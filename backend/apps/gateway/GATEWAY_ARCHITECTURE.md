# Gateway 服务架构与作用分析

## 1. Gateway 服务概述

Gateway 是 StructForge 工作流平台的 **API 网关服务**，作为整个系统的统一入口，负责接收所有客户端请求，并将请求路由到相应的后端微服务。

### 1.1 核心定位

Gateway 是整个工作流平台的 **唯一对外接口**，所有用户请求都必须通过 Gateway 才能访问后端服务。

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (Vue3)                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  工作流编辑器  │  │   用户管理    │  │   监控面板    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │ HTTP/WebSocket
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Gateway (API Gateway)                     │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  统一入口、路由转发、认证授权、限流、日志、监控          │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │ gRPC
        ┌───────────────────┼───────────────────┐
        ▼                   ▼                   ▼
┌──────────────┐  ┌────────────────┐  ┌──────────────┐
│ User Service │  │Workflow Service│  │  AI Service  │
└──────────────┘  └────────────────┘  └──────────────┘
```

## 2. Gateway 的核心作用

### 2.1 统一入口（Single Entry Point）

**作用**：作为整个系统的唯一 HTTP 入口，客户端只需要知道 Gateway 的地址。

**优势**：
- **简化客户端配置**：客户端只需要配置一个 Gateway 地址
- **隐藏后端服务细节**：后端服务的地址、端口、协议对客户端透明
- **便于服务治理**：可以统一管理所有服务的访问

**当前实现**：
- HTTP 服务器监听 `:8000` 端口
- 提供健康检查接口：`/health` 和 `/api/v1/health`

### 2.2 请求路由（Request Routing）

**作用**：根据请求路径和方法，将请求转发到相应的后端微服务。

**路由规则示例**：
```
/api/v1/users/*          → User Service
/api/v1/workflows/*       → Workflow Service
/api/v1/ai/*             → AI Service
/api/v1/nodes/*          → Node Service
/api/v1/tools/*          → Tool Service
/api/v1/scheduler/*      → Scheduler Service
/api/v1/logs/*           → Log Service
```

**当前状态**：
- ✅ 基础 HTTP 服务器已实现
- ⏳ 路由转发功能待实现
- ⏳ 服务发现集成待实现

### 2.3 认证授权（Authentication & Authorization）

**作用**：统一处理用户身份验证和权限控制。

**功能**：
1. **JWT Token 验证**：验证用户登录凭证
2. **权限检查**：检查用户是否有权限访问特定资源
3. **用户上下文注入**：将用户信息注入到请求上下文中

**当前状态**：
- ⏳ JWT 中间件待实现
- ⏳ 权限验证逻辑待实现
- ⏳ 用户上下文管理待实现

### 2.4 限流保护（Rate Limiting）

**作用**：防止恶意请求和系统过载。

**限流策略**：
- **IP 限流**：限制单个 IP 的请求频率
- **用户限流**：限制单个用户的请求频率
- **API 限流**：限制特定 API 的请求频率
- **全局限流**：限制整个系统的请求总量

**当前状态**：
- ⏳ 限流中间件待实现
- ⏳ 限流规则配置待实现
- ⏳ Redis 限流器待集成

### 2.5 请求日志（Request Logging）

**作用**：记录所有经过 Gateway 的请求，用于监控和排查问题。

**日志内容**：
- 请求路径、方法、参数
- 响应状态码、响应时间
- 用户信息、IP 地址
- 错误信息、异常堆栈

**当前状态**：
- ✅ 统一日志系统已集成
- ⏳ 请求日志中间件待实现
- ⏳ 日志格式标准化待实现

### 2.6 监控指标（Metrics）

**作用**：收集系统运行指标，用于监控和告警。

**指标类型**：
- **请求指标**：QPS、响应时间、错误率
- **服务指标**：服务健康状态、连接数
- **系统指标**：CPU、内存、网络

**当前状态**：
- ⏳ 指标收集待实现
- ⏳ Prometheus 集成待实现
- ⏳ 监控面板待实现

### 2.7 跨域支持（CORS）

**作用**：支持前端跨域请求。

**当前状态**：
- ⏳ CORS 中间件待实现

### 2.8 请求转换（Request Transformation）

**作用**：在转发请求前，对请求进行转换和增强。

**转换内容**：
- **协议转换**：HTTP → gRPC
- **数据格式转换**：JSON → Protobuf
- **请求头添加**：添加追踪 ID、用户信息等
- **请求体修改**：参数验证、默认值填充

**当前状态**：
- ⏳ 协议转换待实现
- ⏳ 数据格式转换待实现

## 3. Gateway 的架构设计

### 3.1 分层架构

```
┌─────────────────────────────────────────┐
│          Handler Layer (HTTP)            │  ← 接收 HTTP 请求
│  - 路由匹配                              │
│  - 请求解析                              │
│  - 响应格式化                            │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│         Middleware Layer                │  ← 中间件链
│  - 认证授权                              │
│  - 限流                                  │
│  - 日志                                  │
│  - 监控                                  │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│          Business Layer                 │  ← 业务逻辑
│  - 路由决策                              │
│  - 服务发现                              │
│  - 负载均衡                              │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│          Data Layer (gRPC)              │  ← 调用后端服务
│  - gRPC 客户端                           │
│  - 连接池管理                            │
│  - 服务注册发现                          │
└─────────────────────────────────────────┘
```

### 3.2 核心组件

#### 3.2.1 HTTP Server
- **位置**：`internal/server/http.go`
- **作用**：创建和配置 HTTP 服务器
- **当前实现**：基础 HTTP 服务器，监听 `:8000`

#### 3.2.2 Handler
- **位置**：`internal/handler/`
- **作用**：处理 HTTP 请求
- **当前实现**：健康检查接口

#### 3.2.3 Middleware
- **位置**：`internal/middleware/`（待创建）
- **作用**：实现认证、限流、日志等中间件
- **当前状态**：待实现

#### 3.2.4 Router
- **位置**：`internal/router/`（待创建）
- **作用**：路由匹配和转发
- **当前状态**：待实现

#### 3.2.5 Service Client
- **位置**：`internal/data/client/`（待创建）
- **作用**：gRPC 客户端，调用后端服务
- **当前状态**：待实现

## 4. Gateway 的工作流程

### 4.1 请求处理流程

```
1. 客户端发送 HTTP 请求
   ↓
2. Gateway 接收请求（HTTP Server）
   ↓
3. 中间件链处理
   ├─ CORS 处理
   ├─ 请求日志记录
   ├─ JWT 认证
   ├─ 权限验证
   ├─ 限流检查
   └─ 错误处理
   ↓
4. 路由匹配（Router）
   ├─ 解析请求路径
   ├─ 匹配路由规则
   └─ 确定目标服务
   ↓
5. 服务发现（Service Discovery）
   ├─ 查找服务实例
   ├─ 负载均衡选择
   └─ 获取服务地址
   ↓
6. 协议转换（Protocol Conversion）
   ├─ HTTP → gRPC
   ├─ JSON → Protobuf
   └─ 请求头转换
   ↓
7. 调用后端服务（gRPC Client）
   ├─ 建立连接
   ├─ 发送请求
   └─ 接收响应
   ↓
8. 响应处理
   ├─ 协议转换（gRPC → HTTP）
   ├─ 数据格式转换（Protobuf → JSON）
   ├─ 错误处理
   └─ 响应日志
   ↓
9. 返回响应给客户端
```

### 4.2 当前实现状态

| 功能模块 | 状态 | 说明 |
|---------|------|------|
| HTTP 服务器 | ✅ 已完成 | 基础 HTTP 服务器已实现 |
| 健康检查 | ✅ 已完成 | `/health` 接口已实现 |
| 日志系统 | ✅ 已完成 | 统一日志系统已集成 |
| 配置管理 | ✅ 已完成 | Nacos 配置中心已集成 |
| 缓存系统 | ✅ 已完成 | Redis/内存缓存已集成 |
| 路由转发 | ⏳ 待实现 | 需要实现路由匹配和转发 |
| 认证授权 | ⏳ 待实现 | JWT 认证和权限验证 |
| 限流保护 | ⏳ 待实现 | 请求限流中间件 |
| 服务发现 | ⏳ 待实现 | 后端服务发现和负载均衡 |
| 协议转换 | ⏳ 待实现 | HTTP ↔ gRPC 转换 |
| 监控指标 | ⏳ 待实现 | Prometheus 指标收集 |
| CORS 支持 | ⏳ 待实现 | 跨域请求支持 |

## 5. Gateway 作为工作流平台网关的职责

### 5.1 用户请求入口

**职责**：接收所有用户请求，包括：
- 工作流设计请求（创建、编辑、删除工作流）
- 工作流执行请求（启动、停止、查询执行状态）
- 用户管理请求（登录、注册、权限管理）
- AI 模型调用请求（文本生成、图像生成等）
- 节点管理请求（节点列表、节点文档）
- 工具调用请求（外部工具集成）

### 5.2 工作流相关路由

**路由规则**：
```
POST   /api/v1/workflows              → 创建工作流
GET    /api/v1/workflows              → 获取工作流列表
GET    /api/v1/workflows/:id          → 获取工作流详情
PUT    /api/v1/workflows/:id          → 更新工作流
DELETE /api/v1/workflows/:id          → 删除工作流
POST   /api/v1/workflows/:id/execute  → 执行工作流
GET    /api/v1/workflows/:id/status   → 查询执行状态
GET    /api/v1/workflows/:id/logs     → 获取执行日志
```

### 5.3 工作流执行流程

```
用户请求执行工作流
   ↓
Gateway 接收请求
   ↓
认证授权（验证用户身份和权限）
   ↓
路由到 Workflow Service
   ↓
Workflow Service 创建工作流执行任务
   ↓
Gateway 返回执行任务 ID
   ↓
用户通过 WebSocket 订阅执行状态
   ↓
Gateway 转发执行状态更新
```

### 5.4 实时通信支持

**WebSocket 支持**：
- 工作流执行状态实时推送
- 执行日志实时推送
- 系统通知推送

**当前状态**：
- ⏳ WebSocket 服务器待实现
- ⏳ 连接管理待实现
- ⏳ 消息推送待实现

## 6. Gateway 的扩展性设计

### 6.1 插件化中间件

Gateway 支持插件化的中间件系统，可以灵活添加新的中间件：

```go
// 中间件接口
type Middleware interface {
    Handle(ctx context.Context, req *Request, next Handler) (*Response, error)
}

// 中间件链
type MiddlewareChain struct {
    middlewares []Middleware
}
```

### 6.2 动态路由配置

支持通过配置文件或配置中心动态更新路由规则，无需重启服务。

### 6.3 服务发现集成

支持多种服务发现机制：
- Nacos（当前已集成配置中心）
- Consul
- etcd
- Kubernetes Service Discovery

### 6.4 负载均衡策略

支持多种负载均衡算法：
- 轮询（Round Robin）
- 加权轮询（Weighted Round Robin）
- 最少连接（Least Connections）
- 一致性哈希（Consistent Hashing）

## 7. 下一步开发计划

### 7.1 短期目标（Phase 1）

1. **路由转发功能**
   - 实现路由匹配算法
   - 实现请求转发逻辑
   - 集成服务发现

2. **认证授权**
   - 实现 JWT 认证中间件
   - 实现权限验证逻辑
   - 实现用户上下文管理

3. **限流保护**
   - 实现限流中间件
   - 集成 Redis 限流器
   - 实现限流规则配置

### 7.2 中期目标（Phase 2）

1. **协议转换**
   - HTTP → gRPC 转换
   - JSON → Protobuf 转换
   - 请求/响应数据转换

2. **监控指标**
   - Prometheus 指标收集
   - 监控面板集成
   - 告警规则配置

3. **WebSocket 支持**
   - WebSocket 服务器实现
   - 连接管理
   - 消息推送

### 7.3 长期目标（Phase 3）

1. **高级功能**
   - 请求缓存
   - 请求重试
   - 熔断降级
   - 灰度发布

2. **性能优化**
   - 连接池优化
   - 请求批处理
   - 异步处理

3. **安全增强**
   - API 密钥管理
   - IP 白名单
   - DDoS 防护

## 8. 总结

Gateway 作为 StructForge 工作流平台的 API 网关，承担着以下核心职责：

1. **统一入口**：作为整个系统的唯一 HTTP 入口
2. **请求路由**：将请求转发到相应的后端服务
3. **认证授权**：统一处理用户身份验证和权限控制
4. **限流保护**：防止系统过载和恶意请求
5. **监控日志**：记录请求日志和系统指标
6. **协议转换**：HTTP ↔ gRPC 协议转换

当前 Gateway 已经完成了基础架构搭建，包括：
- ✅ HTTP 服务器
- ✅ 日志系统
- ✅ 配置管理
- ✅ 缓存系统

接下来需要实现的核心功能：
- ⏳ 路由转发
- ⏳ 认证授权
- ⏳ 限流保护
- ⏳ 服务发现
- ⏳ 协议转换

通过这些功能的实现，Gateway 将成为整个工作流平台的强大网关，为用户提供统一、安全、高效的 API 访问入口。

---

**最后更新**: 2024年

