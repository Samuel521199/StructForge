# StructForge 工作流系统架构分析 - 总结

## 十一、功能分摊总结

### 11.1 各微服务职责划分

#### Gateway Service（API 网关）
**职责：**
- ✅ 统一入口：所有客户端请求的入口
- ✅ 路由转发：将请求转发到相应的后端服务
- ✅ 认证授权：JWT 验证、权限检查
- ✅ 限流保护：防止系统过载
- ✅ 日志记录：记录所有请求
- ✅ 监控指标：收集系统指标

**不负责：**
- ❌ 业务逻辑处理
- ❌ 数据持久化
- ❌ 工作流执行

#### Workflow Service（工作流服务）
**职责：**
- ✅ 工作流定义管理（CRUD）
- ✅ 工作流版本控制
- ✅ 工作流执行管理
- ✅ 执行状态管理
- ✅ 执行历史查询
- ✅ 工作流模板管理
- ✅ 执行引擎（解析、调度、执行）

**不负责：**
- ❌ 节点具体逻辑执行（委托给 Node Service）
- ❌ 定时任务调度（委托给 Scheduler Service）
- ❌ 日志存储（委托给 Log Service）

#### Node Service（节点服务）
**职责：**
- ✅ 节点类型管理
- ✅ 节点元数据管理
- ✅ 节点执行器实现
- ✅ 节点参数验证
- ✅ 节点插件管理

**节点执行器分类：**
- 触发节点执行器（webhook、timer、manual、event）
- AI 节点执行器（text_generation、image_generation、chat、embedding，调用 AI Service）
- 数据处理节点执行器（transform、filter、aggregate、map、sort，本地执行）
- 集成节点执行器（http、database、message_queue、email、webhook，调用外部服务）
- 控制节点执行器（condition、loop、parallel、switch、delay，本地执行）
- 工具节点执行器（script、file_operation、system_command，调用 Tool Service）

**节点总数：26 种**

**不负责：**
- ❌ 工作流定义管理
- ❌ 执行状态管理
- ❌ 执行历史存储

#### AI Service（AI 模型服务）
**职责：**
- ✅ AI 模型配置管理
- ✅ AI 模型适配器实现
- ✅ AI API 调用封装
- ✅ 模型限流和监控
- ✅ 模型响应缓存

**支持的模型：**
- OpenAI（GPT-3.5、GPT-4）
- Google Gemini
- Ollama（本地模型）
- 自定义模型

**不负责：**
- ❌ 工作流执行逻辑
- ❌ 节点执行逻辑

#### Scheduler Service（调度服务）
**职责：**
- ✅ 定时任务管理
- ✅ Cron 表达式解析
- ✅ 任务调度和执行
- ✅ 任务队列管理
- ✅ 任务重试机制

**不负责：**
- ❌ 工作流定义管理
- ❌ 工作流执行（只负责触发）

#### Tool Service（工具服务）
**职责：**
- ✅ 外部工具集成管理
- ✅ 工具配置管理
- ✅ 工具调用封装
- ✅ 工具执行结果处理

**不负责：**
- ❌ 工作流执行逻辑

#### Log Service（日志服务）
**职责：**
- ✅ 执行日志收集
- ✅ 日志存储和查询
- ✅ 日志分析
- ✅ 日志导出

**不负责：**
- ❌ 业务逻辑处理

#### User Service（用户服务）
**职责：**
- ✅ 用户管理
- ✅ 认证授权
- ✅ 权限管理
- ✅ 用户配置

**不负责：**
- ❌ 工作流相关功能

---

### 11.2 数据流总结

#### 11.2.1 工作流创建流程
```
用户 → Gateway → Workflow Service → PostgreSQL
```

#### 11.2.2 工作流执行流程
```
用户 → Gateway → Workflow Service → Node Service → AI/Tool Service
                                              ↓
                                        Log Service
```

#### 11.2.3 定时任务流程
```
Scheduler Service → 消息队列 → Workflow Service → Node Service
```

---

### 11.3 关键技术选型

#### 11.3.1 后端技术栈
- **框架**：Kratos（Go 微服务框架）
- **协议**：gRPC + HTTP Gateway
- **数据库**：PostgreSQL（主数据库）+ Redis（缓存/队列）
- **消息队列**：RabbitMQ 或 Redis Streams
- **服务发现**：Nacos / Consul
- **配置中心**：Nacos

#### 11.3.2 前端技术栈
- **框架**：Vue 3 + TypeScript
- **UI 库**：Element Plus
- **工作流编辑器**：Vue Flow
- **状态管理**：Pinia
- **HTTP 客户端**：Axios

---

### 11.4 实施优先级建议

#### Phase 1：核心功能（MVP）
1. ✅ Gateway Service 基础功能
2. ✅ User Service 用户管理
3. ⏳ Workflow Service 工作流定义管理
4. ⏳ Node Service 基础节点执行
5. ⏳ 工作流编辑器前端

#### Phase 2：执行引擎
1. ⏳ Workflow Service 执行引擎
2. ⏳ Node Service 完整节点实现
3. ⏳ AI Service AI 模型集成
4. ⏳ 执行状态管理和日志

#### Phase 3：高级功能
1. ⏳ Scheduler Service 定时任务
2. ⏳ Tool Service 工具集成
3. ⏳ 工作流模板系统
4. ⏳ 工作流版本控制

#### Phase 4：优化和扩展
1. ⏳ 性能优化
2. ⏳ 监控和告警
3. ⏳ 插件系统
4. ⏳ 多租户支持

---

## 十二、前端界面改进清单

### 12.1 仪表盘改进

#### 必须实现
- [ ] 添加"创建新工作流"按钮（右上角，主要操作）
- [ ] 添加快速操作卡片区域
- [ ] 添加最近工作流快捷入口

#### 可选实现
- [ ] 工作流模板快捷入口
- [ ] 导入工作流功能
- [ ] 工作流统计图表增强

### 12.2 工作流列表页面改进

#### 必须实现
- [ ] 视图切换（表格/卡片）
- [ ] 批量操作功能
- [ ] 高级筛选功能增强

#### 可选实现
- [ ] 工作流分组管理
- [ ] 工作流标签系统
- [ ] 工作流搜索增强

### 12.3 工作流编辑器改进

#### 必须实现
- [ ] 工具栏功能增强
- [ ] 节点面板搜索功能
- [ ] 画布快捷键支持
- [ ] 属性面板增强

#### 可选实现
- [ ] 调试面板
- [ ] 工作流版本对比
- [ ] 工作流模板保存

---

## 十三、后端服务开发清单

### 13.1 Workflow Service

#### 必须实现
- [ ] 工作流 CRUD API
- [ ] 工作流执行 API
- [ ] 执行引擎（DAG 解析和执行）
- [ ] 执行状态管理
- [ ] 执行历史查询

#### 可选实现
- [ ] 工作流版本控制
- [ ] 工作流模板管理
- [ ] 工作流导入/导出
- [ ] 工作流分享功能

### 13.2 Node Service

#### 必须实现
- [ ] 节点类型注册
- [ ] 基础节点执行器（触发、数据处理、控制）
- [ ] 节点参数验证
- [ ] 节点执行结果处理

#### 可选实现
- [ ] 节点插件系统
- [ ] 自定义节点支持
- [ ] 节点执行缓存

### 13.3 Scheduler Service

#### 必须实现
- [ ] 定时任务管理 API
- [ ] Cron 表达式解析
- [ ] 任务调度引擎
- [ ] 任务队列管理

#### 可选实现
- [ ] 任务重试机制
- [ ] 任务优先级管理
- [ ] 任务执行历史

### 13.4 AI Service

#### 必须实现
- [ ] AI 模型配置管理
- [ ] OpenAI 适配器
- [ ] Gemini 适配器
- [ ] Ollama 适配器
- [ ] AI API 调用封装

#### 可选实现
- [ ] 模型响应缓存
- [ ] 模型限流
- [ ] 模型监控

---

## 十四、总结

### 14.1 核心设计原则

1. **单一职责**：每个微服务只负责自己的业务领域
2. **松耦合**：服务间通过明确的接口通信
3. **高内聚**：相关功能集中在同一服务
4. **可扩展**：支持水平扩展和插件化
5. **可观测**：完善的日志、监控、追踪

### 14.2 关键设计决策

1. **执行引擎在 Workflow Service**：工作流执行逻辑集中管理
2. **节点执行在 Node Service**：节点逻辑独立，便于扩展
3. **定时任务独立服务**：Scheduler Service 专门处理调度
4. **AI 模型统一管理**：AI Service 统一管理所有 AI 模型
5. **日志集中管理**：Log Service 统一收集和存储日志

### 14.3 下一步行动

1. **完善前端界面**：添加创建按钮、优化布局
2. **实现 Workflow Service**：核心工作流管理功能
3. **实现 Node Service**：基础节点执行器
4. **实现执行引擎**：DAG 解析和执行逻辑
5. **集成 AI Service**：AI 模型调用功能

---

**分析文档完成**

