# StructForge 工作流平台架构设计

## 1. 项目概述

StructForge 是一个全功能的AI工作流编排平台，支持多种AI大模型（开源、自建、公共API）和各种工作节点，提供可视化的流程设计界面。

## 2. 整体架构

### 2.1 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (Vue3)                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  工作流编辑器  │  │   用户管理    │  │   监控面板    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │ HTTP/WebSocket
┌─────────────────────────────────────────────────────────────┐
│                    API Gateway (Kratos)                      │
│             统一入口、路由、认证、限流                          │
└─────────────────────────────────────────────────────────────┘
                            │ gRPC
┌─────────────────────────────────────────────────────────────┐
│                      微服务层 (Go + Kratos)                   │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │ 用户服务  │ │工作流服务 │ │ AI模型服务│ │节点服务   │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                    │
│  │工具服务  │ │调度服务  │ │日志服务  │                    │
│  └──────────┘ └──────────┘ └──────────┘                    │
└─────────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────────┐
│                      基础设施层                                │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │PostgreSQL│ │  Redis   │ │RabbitMQ  │ │  Docker  │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
└─────────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────────┐
│                      AI模型接入层                             │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │ OpenAI   │ │ Gemini   │ │ Ollama   │ │ 自建模型  │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 技术栈选型

#### 前端技术栈
- **框架**: Vue 3.x (Composition API)
- **构建工具**: Vite
- **状态管理**: Pinia
- **UI组件库**: Element Plus 或 Ant Design Vue
- **工作流编辑器**: 基于 Vue Flow / LogicFlow 或自研
- **HTTP客户端**: Axios
- **WebSocket**: Socket.io-client 或原生 WebSocket
- **类型检查**: TypeScript

#### 后端技术栈
- **框架**: Kratos (Bilibili开源微服务框架)
- **协议**: gRPC + HTTP Gateway
- **数据库**: PostgreSQL (主数据库) + Redis (缓存/队列)
- **消息队列**: RabbitMQ (可选，用于异步任务)
- **服务发现**: Consul / etcd (Kratos内置支持)
- **配置中心**: Kratos配置系统
- **日志**: Zap
- **链路追踪**: OpenTelemetry (可选)

#### 基础设施
- **容器化**: Docker + Docker Compose
- **CI/CD**: GitHub Actions / GitLab CI
- **监控**: Prometheus + Grafana (可选)

#### 文档系统
- **API文档**: OpenAPI 3.0 + Swagger UI（集成到API Gateway）
- **节点说明**: 数据库存储 + API提供（集成到节点服务）
- **工作流说明**: Markdown文件 + API提供（集成到工作流服务）
- **独立文档站**: VitePress（可选，用于对外文档）

## 3. 微服务设计

### 3.1 服务划分

#### 3.1.1 用户服务 (user-service)
**职责**:
- 用户注册、登录、登出
- JWT Token 生成和验证
- 用户信息管理
- 权限管理 (RBAC)
- 组织/团队管理

**主要接口**:
- 用户注册/登录
- 用户信息CRUD
- 角色权限管理
- 组织管理

#### 3.1.2 工作流服务 (workflow-service)
**职责**:
- 工作流定义存储和管理
- 工作流版本控制
- 工作流执行引擎
- 工作流状态管理
- 工作流模板管理

**核心功能**:
- 工作流CRUD
- 工作流执行（同步/异步）
- 工作流暂停/恢复/停止
- 工作流历史记录

#### 3.1.3 AI模型服务 (ai-service)
**职责**:
- 多种AI模型统一接入
- 模型配置管理
- 模型调用封装
- 模型调用限流和监控
- 模型响应缓存

**支持的模型类型**:
- OpenAI (ChatGPT, GPT-4等)
- Google Gemini
- 开源模型 (Ollama, LocalAI等)
- 自建模型 (通过API或SDK)
- 小型AI模型 (HuggingFace等)

**设计模式**: 策略模式 + 适配器模式

#### 3.1.4 节点服务 (node-service)
**职责**:
- 各种工作流节点的实现
- 节点类型管理
- 节点参数验证
- 节点执行逻辑

**节点类型**:
- **触发节点**: Webhook, 定时器, 手动触发, 事件触发
- **AI节点**: 文本生成, 图像生成, 代码生成, 数据分析
- **数据处理节点**: 数据转换, 数据过滤, 数据聚合
- **集成节点**: HTTP请求, 数据库操作, 文件操作
- **控制节点**: 条件判断, 循环, 并行, 延迟
- **工具节点**: 代码执行, 脚本执行, 外部工具调用

#### 3.1.5 工具服务 (tool-service)
**职责**:
- 外部工具集成
- 工具配置管理
- 工具调用封装
- 工具结果处理

**工具类型**:
- 代码执行器 (Python, JavaScript, Shell等)
- 文件处理工具
- 网络工具
- 系统工具

#### 3.1.6 调度服务 (scheduler-service)
**职责**:
- 定时任务调度
- 工作流定时执行
- 任务队列管理
- 任务重试机制
- 任务优先级管理

**技术选型**: 基于 Cron 或分布式任务调度框架

#### 3.1.7 日志服务 (log-service)
**职责**:
- 工作流执行日志收集
- 系统日志聚合
- 日志查询和分析
- 日志存储和归档

#### 3.1.8 API Gateway
**职责**:
- 统一API入口
- 请求路由
- 认证鉴权
- 限流熔断
- 请求日志
- API文档服务（Swagger UI）

#### 3.1.9 文档服务（可选独立服务）
**职责**:
- API文档管理（OpenAPI规范）
- 节点使用说明管理
- 工作流使用说明管理
- 文档版本控制
- 文档搜索

**说明**: 文档功能可以独立为服务，也可以集成到现有服务中。推荐集成方案：
- API文档：集成到API Gateway
- 节点说明：集成到节点服务
- 工作流说明：集成到工作流服务

## 4. 数据模型设计

### 4.1 核心数据表

#### 用户相关
- `users`: 用户表
- `roles`: 角色表
- `permissions`: 权限表
- `user_roles`: 用户角色关联表
- `role_permissions`: 角色权限关联表
- `organizations`: 组织表
- `user_organizations`: 用户组织关联表

#### 工作流相关
- `workflows`: 工作流定义表
- `workflow_versions`: 工作流版本表
- `workflow_executions`: 工作流执行记录表
- `workflow_nodes`: 工作流节点定义表
- `workflow_edges`: 工作流边定义表
- `execution_logs`: 执行日志表

#### AI模型相关
- `ai_models`: AI模型配置表
- `model_configs`: 模型配置详情表
- `model_usage_logs`: 模型使用日志表

#### 节点相关
- `node_types`: 节点类型表
- `node_templates`: 节点模板表

## 5. 工作流执行引擎设计

### 5.1 执行模式

#### 同步执行
- 适用于简单、快速的工作流
- 直接返回执行结果
- 超时控制

#### 异步执行
- 适用于复杂、耗时的任务
- 返回任务ID，通过WebSocket推送进度
- 支持任务查询和取消

### 5.2 执行流程

```
1. 接收执行请求
2. 验证工作流定义
3. 创建工作流执行实例
4. 初始化执行上下文
5. 按拓扑顺序执行节点
   - 节点参数验证
   - 节点前置处理
   - 节点执行
   - 节点后置处理
   - 结果传递给下游节点
6. 处理异常和重试
7. 记录执行日志
8. 返回执行结果
```

### 5.3 节点执行机制

- **串行执行**: 按边顺序依次执行
- **并行执行**: 支持分支并行
- **条件执行**: 根据条件选择分支
- **循环执行**: 支持循环节点
- **错误处理**: 节点失败处理策略（继续/停止/重试）

## 6. AI模型接入设计

### 6.1 统一接口设计

```go
type AIModel interface {
    // 模型调用
    Call(ctx context.Context, request *ModelRequest) (*ModelResponse, error)
    // 模型配置
    GetConfig() *ModelConfig
    // 模型健康检查
    HealthCheck(ctx context.Context) error
}
```

### 6.2 模型适配器

- **OpenAI适配器**: 对接OpenAI API
- **Gemini适配器**: 对接Google Gemini API
- **Ollama适配器**: 对接本地Ollama服务
- **自定义适配器**: 支持自定义模型接入

### 6.3 模型管理

- 模型配置存储
- 模型调用限流
- 模型调用监控
- 模型响应缓存

## 7. 前端工作流编辑器设计

### 7.1 编辑器功能

- **画布**: 拖拽式节点编排
- **节点库**: 可扩展的节点类型
- **连接线**: 节点间数据流连接
- **属性面板**: 节点参数配置
- **预览/调试**: 工作流预览和调试
- **保存/发布**: 工作流版本管理

### 7.2 节点渲染

- 不同类型节点不同图标和颜色
- 节点状态可视化（待执行/执行中/成功/失败）
- 节点输入输出端口

### 7.3 数据流可视化

- 显示节点间数据传递
- 实时执行状态反馈
- 执行日志展示

## 8. 安全设计

### 8.1 认证授权

- JWT Token认证
- RBAC权限控制
- API密钥管理（用于AI模型调用）

### 8.2 数据安全

- 敏感数据加密存储
- API密钥加密
- 工作流数据隔离（多租户）

### 8.3 网络安全

- HTTPS支持
- API限流
- 请求签名验证

## 9. 部署架构

### 9.1 开发环境

- 本地Docker Compose部署
- 所有服务运行在localhost
- 简化配置

### 9.2 生产环境

- Kubernetes部署（可选）
- 服务高可用
- 负载均衡
- 自动扩缩容

## 10. 扩展性设计

### 10.1 节点扩展

- 插件化节点系统
- 自定义节点开发SDK
- 节点市场

### 10.2 模型扩展

- 模型适配器插件化
- 新模型快速接入

### 10.3 工具扩展

- 工具插件系统
- 第三方工具集成

