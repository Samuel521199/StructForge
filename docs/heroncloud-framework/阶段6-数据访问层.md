# é˜¶æ®µ6ï¼šæ•°æ®è®¿é—®å±‚ï¼ˆRedisï¼‰

## ğŸ“š å­¦ä¹ ç›®æ ‡
- ç†è§£æ•°æ®è®¿é—®å±‚çš„è®¾è®¡
- æŒæ¡Rediså®¢æˆ·ç«¯çš„å°è£…
- å­¦ä¹ è¿æ¥æ± ç®¡ç†
- ç†è§£èµ„æºæ¸…ç†æœºåˆ¶

---

## ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®è®¿é—®å±‚ï¼Ÿ

### æ•°æ®è®¿é—®å±‚çš„ä½œç”¨

1. **ç»Ÿä¸€æ¥å£**
   - å°è£…åº•å±‚æ•°æ®åº“æ“ä½œ
   - æä¾›ç»Ÿä¸€çš„API

2. **è¿æ¥ç®¡ç†**
   - ç®¡ç†æ•°æ®åº“è¿æ¥æ± 
   - å¤„ç†è¿æ¥å¤±è´¥é‡è¯•

3. **èµ„æºæ¸…ç†**
   - ç¡®ä¿è¿æ¥æ­£ç¡®å…³é—­
   - é˜²æ­¢èµ„æºæ³„æ¼

4. **æ˜“äºæµ‹è¯•**
   - å¯ä»¥æ›¿æ¢ä¸ºMockå®ç°
   - ä¾¿äºå•å…ƒæµ‹è¯•

---

## ğŸ“ æ ¸å¿ƒä»£ç ï¼šRediså®¢æˆ·ç«¯å°è£…

### å®Œæ•´ä»£ç ï¼ˆæ‰‹å†™ç»ƒä¹ ï¼‰

```go
package redis

import (
    "HeronGame/common/data/redis/conf"
    "HeronGame/common/log"
    "context"
    "time"

    "github.com/redis/go-redis/v9"
    "go.uber.org/zap"
)

// NewRedisClient åˆå§‹åŒ– Redis è¿æ¥
func NewRedisClient(bc *conf.Redis) (redis.UniversalClient, func(), error) {
    // 1. åˆ›å»ºRediså®¢æˆ·ç«¯
    rdb := redis.NewClient(&redis.Options{
        Network:         bc.Network,                    // ç½‘ç»œç±»å‹ï¼ˆtcpï¼‰
        Addr:            bc.Addr,                       // åœ°å€ï¼ˆlocalhost:6379ï¼‰
        ReadTimeout:     bc.ReadTimeout.AsDuration(),    // è¯»è¶…æ—¶
        WriteTimeout:    bc.WriteTimeout.AsDuration(),  // å†™è¶…æ—¶
        DB:              int(bc.Db),                    // æ•°æ®åº“ç¼–å·
        Password:        bc.Password,                  // å¯†ç 
        PoolSize:        int(bc.PoolSize),             // è¿æ¥æ± å¤§å°
        MinIdleConns:    int(bc.MinIdleConns),          // æœ€å°ç©ºé—²è¿æ¥æ•°
        ConnMaxLifetime: bc.ConnMaxLifetime.AsDuration(), // è¿æ¥æœ€å¤§ç”Ÿå­˜æ—¶é—´
        DialTimeout:     bc.DialTimeout.AsDuration(),   // è¿æ¥è¶…æ—¶
        PoolTimeout:     bc.PoolTimeout.AsDuration(),    // è·å–è¿æ¥è¶…æ—¶
        MaxRetries:      int(bc.MaxRetries),            // æœ€å¤§é‡è¯•æ¬¡æ•°
        MinRetryBackoff: bc.MinRetryBackoff.AsDuration(), // æœ€å°é‡è¯•é—´éš”
        MaxRetryBackoff: bc.MaxRetryBackoff.AsDuration(), // æœ€å¤§é‡è¯•é—´éš”
    })

    // 2. å®šä¹‰æ¸…ç†å‡½æ•°
    cleanup := func() {
        if err := rdb.Close(); err != nil {
            log.Error(context.Background(), "å…³é—­Redisè¿æ¥å¤±è´¥", zap.Error(err))
        }
    }

    // 3. æµ‹è¯•è¿æ¥
    ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
    defer cancel()

    if err := rdb.Ping(ctx).Err(); err != nil {
        return nil, cleanup, err
    }

    // 4. è¿”å›å®¢æˆ·ç«¯å’Œæ¸…ç†å‡½æ•°
    return rdb, cleanup, nil
}
```

---

## ğŸ“– ä»£ç è¯¦è§£

### 1. Rediså®¢æˆ·ç«¯é€‰é¡¹

```go
rdb := redis.NewClient(&redis.Options{
    Addr: "localhost:6379",
    // ... å…¶ä»–é€‰é¡¹
})
```

**å…³é”®é…ç½®è¯´æ˜ï¼š**

| é…ç½®é¡¹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|------|--------|
| `Network` | ç½‘ç»œç±»å‹ | "tcp" |
| `Addr` | æœåŠ¡å™¨åœ°å€ | "localhost:6379" |
| `Password` | å¯†ç  | "mypassword" |
| `DB` | æ•°æ®åº“ç¼–å· | 0 |
| `PoolSize` | è¿æ¥æ± å¤§å° | 10 |
| `MinIdleConns` | æœ€å°ç©ºé—²è¿æ¥ | 5 |
| `ReadTimeout` | è¯»è¶…æ—¶ | 3ç§’ |
| `WriteTimeout` | å†™è¶…æ—¶ | 3ç§’ |

### 2. è¿æ¥æ± ç®¡ç†

**è¿æ¥æ± çš„ä½œç”¨ï¼š**
- å¤ç”¨è¿æ¥ï¼Œé¿å…é¢‘ç¹åˆ›å»º
- é™åˆ¶å¹¶å‘è¿æ¥æ•°
- æé«˜æ€§èƒ½

**è¿æ¥æ± å‚æ•°ï¼š**
```go
PoolSize: 10,        // æœ€å¤š10ä¸ªè¿æ¥
MinIdleConns: 5,    // è‡³å°‘ä¿æŒ5ä¸ªç©ºé—²è¿æ¥
ConnMaxLifetime: 1å°æ—¶, // è¿æ¥æœ€å¤§ç”Ÿå­˜æ—¶é—´
```

**å·¥ä½œåŸç†ï¼š**
```
è¯·æ±‚1 â†’ ä»æ± ä¸­è·å–è¿æ¥ â†’ ä½¿ç”¨ â†’ å½’è¿˜åˆ°æ± 
è¯·æ±‚2 â†’ ä»æ± ä¸­è·å–è¿æ¥ â†’ ä½¿ç”¨ â†’ å½’è¿˜åˆ°æ± 
...
å¦‚æœæ± ä¸­æ²¡æœ‰ç©ºé—²è¿æ¥ï¼Œç­‰å¾…æˆ–åˆ›å»ºæ–°è¿æ¥ï¼ˆä¸è¶…è¿‡PoolSizeï¼‰
```

### 3. è¶…æ—¶é…ç½®

```go
ReadTimeout:  3ç§’,  // è¯»å–æ•°æ®è¶…æ—¶
WriteTimeout: 3ç§’,  // å†™å…¥æ•°æ®è¶…æ—¶
DialTimeout:  5ç§’,  // å»ºç«‹è¿æ¥è¶…æ—¶
PoolTimeout:  5ç§’,  // ä»æ± è·å–è¿æ¥è¶…æ—¶
```

**ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶ï¼Ÿ**
- é˜²æ­¢è¯·æ±‚æ— é™ç­‰å¾…
- å¿«é€Ÿå‘ç°ç½‘ç»œé—®é¢˜
- ä¿æŠ¤æœåŠ¡å™¨èµ„æº

### 4. é‡è¯•æœºåˆ¶

```go
MaxRetries:      3,           // æœ€å¤šé‡è¯•3æ¬¡
MinRetryBackoff: 8æ¯«ç§’,       // æœ€å°é‡è¯•é—´éš”
MaxRetryBackoff: 512æ¯«ç§’,     // æœ€å¤§é‡è¯•é—´éš”
```

**é‡è¯•ç­–ç•¥ï¼š**
- ç¬¬ä¸€æ¬¡å¤±è´¥åï¼Œç­‰å¾…8msé‡è¯•
- ç¬¬äºŒæ¬¡å¤±è´¥åï¼Œç­‰å¾…æ›´é•¿æ—¶é—´ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
- æœ€å¤šé‡è¯•3æ¬¡

### 5. èµ„æºæ¸…ç†

```go
cleanup := func() {
    if err := rdb.Close(); err != nil {
        log.Error(context.Background(), "å…³é—­Redisè¿æ¥å¤±è´¥", zap.Error(err))
    }
}
```

**ä¸ºä»€ä¹ˆéœ€è¦cleanupå‡½æ•°ï¼Ÿ**
- ç¨‹åºé€€å‡ºæ—¶å…³é—­è¿æ¥
- é˜²æ­¢èµ„æºæ³„æ¼
- ä¼˜é›…å…³é—­

**ä½¿ç”¨æ–¹å¼ï¼š**
```go
rdb, cleanup, err := NewRedisClient(config)
if err != nil {
    return err
}
defer cleanup()  // ç¡®ä¿é€€å‡ºæ—¶æ¸…ç†
```

### 6. è¿æ¥æµ‹è¯•

```go
ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
defer cancel()

if err := rdb.Ping(ctx).Err(); err != nil {
    return nil, cleanup, err
}
```

**ä½œç”¨ï¼š**
- å¯åŠ¨æ—¶æµ‹è¯•è¿æ¥æ˜¯å¦æ­£å¸¸
- å¿«é€Ÿå‘ç°é…ç½®é”™è¯¯
- é¿å…è¿è¡Œæ—¶æ‰å‘ç°é—®é¢˜

---

## ğŸ”§ Redisä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬æ“ä½œ

```go
// è®¾ç½®å€¼
err := rdb.Set(ctx, "key", "value", time.Hour).Err()
if err != nil {
    log.Error(ctx, "è®¾ç½®Rediså€¼å¤±è´¥", zap.Error(err))
}

// è·å–å€¼
val, err := rdb.Get(ctx, "key").Result()
if err != nil {
    log.Error(ctx, "è·å–Rediså€¼å¤±è´¥", zap.Error(err))
} else {
    log.Info(ctx, "è·å–å€¼æˆåŠŸ", zap.String("value", val))
}

// åˆ é™¤å€¼
err = rdb.Del(ctx, "key").Err()

// è®¾ç½®è¿‡æœŸæ—¶é—´
err = rdb.Expire(ctx, "key", time.Hour).Err()
```

### å“ˆå¸Œæ“ä½œ

```go
// è®¾ç½®å“ˆå¸Œå­—æ®µ
err := rdb.HSet(ctx, "user:123", "name", "å¼ ä¸‰").Err()
err = rdb.HSet(ctx, "user:123", "age", "25").Err()

// è·å–å“ˆå¸Œå­—æ®µ
name, err := rdb.HGet(ctx, "user:123", "name").Result()

// è·å–æ‰€æœ‰å“ˆå¸Œå­—æ®µ
userMap, err := rdb.HGetAll(ctx, "user:123").Result()
```

### åˆ—è¡¨æ“ä½œ

```go
// ä»å·¦ä¾§æ¨å…¥
err := rdb.LPush(ctx, "list", "value1", "value2").Err()

// ä»å³ä¾§å¼¹å‡º
val, err := rdb.RPop(ctx, "list").Result()

// è·å–åˆ—è¡¨é•¿åº¦
length, err := rdb.LLen(ctx, "list").Result()
```

### é›†åˆæ“ä½œ

```go
// æ·»åŠ æˆå‘˜
err := rdb.SAdd(ctx, "set", "member1", "member2").Err()

// æ£€æŸ¥æˆå‘˜æ˜¯å¦å­˜åœ¨
exists, err := rdb.SIsMember(ctx, "set", "member1").Result()

// è·å–æ‰€æœ‰æˆå‘˜
members, err := rdb.SMembers(ctx, "set").Result()
```

---

## ğŸ“ è¿æ¥æ± æœ€ä½³å®è·µ

### 1. åˆç†è®¾ç½®è¿æ¥æ± å¤§å°

```go
// âœ… å¥½çš„åšæ³•ï¼šæ ¹æ®å¹¶å‘é‡è®¾ç½®
PoolSize: 10,  // å¦‚æœå¹¶å‘è¯·æ±‚çº¦10ä¸ªï¼Œè®¾ç½®10ä¸ªè¿æ¥

// âŒ ä¸å¥½çš„åšæ³•ï¼šè®¾ç½®è¿‡å¤§æˆ–è¿‡å°
PoolSize: 1000,  // è¿‡å¤§æµªè´¹èµ„æº
PoolSize: 1,     // è¿‡å°å¯¼è‡´ç­‰å¾…
```

### 2. ä½¿ç”¨Contextæ§åˆ¶è¶…æ—¶

```go
// âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨Contextè¶…æ—¶
ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
defer cancel()

val, err := rdb.Get(ctx, "key").Result()

// âŒ ä¸å¥½çš„åšæ³•ï¼šæ²¡æœ‰è¶…æ—¶æ§åˆ¶
val, err := rdb.Get(context.Background(), "key").Result()
```

### 3. é”™è¯¯å¤„ç†

```go
// âœ… å¥½çš„åšæ³•ï¼šæ£€æŸ¥é”™è¯¯
val, err := rdb.Get(ctx, "key").Result()
if err == redis.Nil {
    // keyä¸å­˜åœ¨
    log.Info(ctx, "keyä¸å­˜åœ¨")
} else if err != nil {
    // å…¶ä»–é”™è¯¯
    log.Error(ctx, "Redisæ“ä½œå¤±è´¥", zap.Error(err))
    return err
} else {
    // æˆåŠŸ
    log.Info(ctx, "è·å–å€¼æˆåŠŸ", zap.String("value", val))
}
```

### 4. æ‰¹é‡æ“ä½œ

```go
// âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨Pipelineæ‰¹é‡æ“ä½œ
pipe := rdb.Pipeline()
pipe.Set(ctx, "key1", "value1", 0)
pipe.Set(ctx, "key2", "value2", 0)
pipe.Set(ctx, "key3", "value3", 0)
_, err := pipe.Exec(ctx)

// âŒ ä¸å¥½çš„åšæ³•ï¼šé€ä¸ªæ“ä½œ
rdb.Set(ctx, "key1", "value1", 0)
rdb.Set(ctx, "key2", "value2", 0)
rdb.Set(ctx, "key3", "value3", 0)
```

---

## ğŸ’¡ å®è·µç»ƒä¹ 

### ç»ƒä¹ 1ï¼šç†è§£è¿æ¥æ± 

ç¼–å†™ä»£ç æµ‹è¯•è¿æ¥æ± ï¼š

```go
func TestConnectionPool() {
    rdb, cleanup, _ := NewRedisClient(config)
    defer cleanup()

    // å¹¶å‘æ‰§è¡Œå¤šä¸ªæ“ä½œï¼Œè§‚å¯Ÿè¿æ¥æ± ä½¿ç”¨æƒ…å†µ
    for i := 0; i < 100; i++ {
        go func(id int) {
            rdb.Set(ctx, fmt.Sprintf("key%d", id), fmt.Sprintf("value%d", id), 0)
        }(i)
    }
}
```

### ç»ƒä¹ 2ï¼šé”™è¯¯å¤„ç†

ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œå¤„ç†Redisçš„å„ç§é”™è¯¯ï¼š

```go
func HandleRedisError(err error) error {
    // TODO: å¤„ç†ä¸åŒç±»å‹çš„é”™è¯¯
    // - redis.Nil (keyä¸å­˜åœ¨)
    // - ç½‘ç»œé”™è¯¯
    // - è¶…æ—¶é”™è¯¯
    // - å…¶ä»–é”™è¯¯
}
```

### ç»ƒä¹ 3ï¼šæ‰¹é‡æ“ä½œ

ä½¿ç”¨Pipelineä¼˜åŒ–æ‰¹é‡æ“ä½œï¼š

```go
func BatchSet(ctx context.Context, rdb redis.UniversalClient, data map[string]string) error {
    // TODO: ä½¿ç”¨Pipelineæ‰¹é‡è®¾ç½®
}
```

---

## ğŸ“Œ ä¸‹ä¸€é˜¶æ®µé¢„å‘Š

**é˜¶æ®µ7ï¼šä¸­é—´ä»¶ç³»ç»Ÿ**
- JWTè®¤è¯ä¸­é—´ä»¶
- é™æµä¸­é—´ä»¶
- é”™è¯¯å¤„ç†ä¸­é—´ä»¶
- é“¾è·¯è¿½è¸ªä¸­é—´ä»¶

---

## â“ æ€è€ƒé¢˜

1. ä¸ºä»€ä¹ˆéœ€è¦è¿æ¥æ± ï¼Ÿç›´æ¥æ¯æ¬¡åˆ›å»ºæ–°è¿æ¥æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ
2. è¿æ¥æ± å¤§å°åº”è¯¥å¦‚ä½•è®¾ç½®ï¼Ÿè®¾ç½®è¿‡å¤§æˆ–è¿‡å°ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Ÿ
3. ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Contextæ§åˆ¶è¶…æ—¶ï¼Ÿæ²¡æœ‰è¶…æ—¶ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ
4. Pipelineå’Œæ™®é€šæ“ä½œæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä»€ä¹ˆæ—¶å€™ä½¿ç”¨Pipelineï¼Ÿ

---

**å®Œæˆæœ¬é˜¶æ®µåï¼Œè¯·ç»§ç»­å­¦ä¹ é˜¶æ®µ7ï¼** ğŸš€

