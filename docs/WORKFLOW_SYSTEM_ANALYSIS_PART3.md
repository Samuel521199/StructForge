# StructForge 工作流系统架构分析 - 第三部分

## 六、微服务间交互设计

### 6.1 服务间通信架构

#### 6.1.1 通信方式

**同步通信（gRPC）：**
- Workflow Service ↔ Node Service
- Workflow Service ↔ AI Service
- Workflow Service ↔ Tool Service
- 适用于需要立即响应的操作

**异步通信（消息队列）：**
- Scheduler Service → Workflow Service（定时任务触发）
- Workflow Service → Log Service（日志记录）
- 适用于解耦和削峰填谷

**事件驱动：**
- 工作流执行完成事件
- 节点执行失败事件
- 使用消息队列实现事件发布/订阅

#### 6.1.2 服务发现

**服务注册：**
- 每个服务启动时向服务注册中心注册
- 携带服务名称、地址、端口、健康状态

**服务发现：**
- Gateway 通过服务发现查找后端服务
- 支持负载均衡（轮询、加权轮询、最少连接）

**健康检查：**
- 定期检查服务健康状态
- 不健康的服务自动从服务列表中移除

### 6.2 工作流执行流程详解

#### 6.2.1 完整执行流程

```
1. 用户触发执行（通过 Gateway）
   ↓
2. Gateway 验证用户身份和权限
   ↓
3. Gateway 转发请求到 Workflow Service
   ↓
4. Workflow Service 创建执行实例
   ↓
5. Workflow Service 解析工作流定义，构建执行图（DAG）
   ↓
6. 按拓扑顺序执行节点：
   ├─ 触发节点：等待触发条件
   ├─ AI 节点：调用 AI Service
   ├─ 数据处理节点：本地执行
   ├─ 集成节点：调用外部服务
   ├─ 控制节点：根据条件分支
   └─ 工具节点：调用 Tool Service
   ↓
7. 每个节点执行：
   a. Workflow Service 调用 Node Service
   b. Node Service 根据节点类型执行相应逻辑
   c. 如果是 AI 节点，Node Service 调用 AI Service
   d. 如果是工具节点，Node Service 调用 Tool Service
   e. 返回执行结果
   ↓
8. Workflow Service 收集节点执行结果
   ↓
9. 更新执行状态（通过 Log Service 记录日志）
   ↓
10. 执行完成，返回结果给用户
```

#### 6.2.2 节点执行详细流程

**AI 节点执行：**
```
Workflow Service
    ↓ (gRPC 调用)
Node Service (AI 节点执行器)
    ↓ (gRPC 调用)
AI Service
    ↓ (HTTP 调用)
外部 AI 模型 API（OpenAI、Gemini 等）
    ↓
返回结果
    ↓
Node Service 处理结果
    ↓
返回给 Workflow Service
```

**集成节点执行：**
```
Workflow Service
    ↓ (gRPC 调用)
Node Service (集成节点执行器)
    ↓ (HTTP/gRPC 调用)
外部服务（数据库、API、消息队列等）
    ↓
返回结果
    ↓
Node Service 处理结果
    ↓
返回给 Workflow Service
```

### 6.3 错误处理和重试机制

#### 6.3.1 错误处理策略

**节点级别错误处理：**
- 每个节点可以配置错误处理策略
- 策略选项：
  - `continue`：继续执行下一个节点
  - `retry`：重试当前节点
  - `fail`：标记执行失败
  - `skip`：跳过当前节点

**工作流级别错误处理：**
- 全局错误处理策略
- 支持自定义错误处理节点
- 错误通知（邮件、Webhook）

#### 6.3.2 重试机制

**重试策略：**
- 固定间隔重试
- 指数退避重试
- 最大重试次数限制

**重试范围：**
- 节点级别重试
- 工作流级别重试
- 系统级别重试（网络错误等）

---

## 七、数据流和状态管理

### 7.1 执行上下文（ExecutionContext）

#### 7.1.1 上下文结构

```go
type ExecutionContext struct {
    ExecutionID string                          // 执行ID
    WorkflowID   string                          // 工作流ID
    Variables    map[string]interface{}          // 全局变量
    NodeOutputs map[string]map[string]interface{} // 节点输出（节点ID -> 输出数据）
    Metadata     map[string]interface{}          // 元数据
}
```

#### 7.1.2 数据传递

**节点间数据传递：**
- 上游节点的输出作为下游节点的输入
- 通过节点ID和输出端口名称引用
- 支持数据转换和映射

**变量作用域：**
- 全局变量：整个工作流可见
- 节点变量：仅在节点内部可见
- 执行变量：仅在当前执行中可见

### 7.2 状态持久化

#### 7.2.1 持久化策略

**执行状态：**
- 实时状态存储在 Redis（快速访问）
- 完整状态存储在 PostgreSQL（持久化）
- 定期同步 Redis 到 PostgreSQL

**执行日志：**
- 实时日志发送到 Log Service
- Log Service 存储到 Elasticsearch 或数据库
- 支持日志查询和分析

**执行结果：**
- 节点执行结果存储在 PostgreSQL
- 支持结果查询和导出
- 大结果数据存储在对象存储（如 MinIO）

---

## 八、性能优化和扩展性

### 8.1 性能优化策略

#### 8.1.1 执行优化

**并行执行：**
- 支持并行节点同时执行
- 使用 Goroutine 池管理并发
- 控制最大并发数

**缓存策略：**
- 工作流定义缓存
- 节点执行结果缓存（相同输入）
- API 响应缓存

**异步处理：**
- 长时间运行的工作流异步执行
- 使用消息队列解耦
- 支持执行状态查询

#### 8.1.2 数据库优化

**索引设计：**
- 工作流表：用户ID、状态、创建时间索引
- 执行表：工作流ID、状态、创建时间索引
- 节点执行表：执行ID、节点ID索引

**分表策略：**
- 按时间分表（执行历史表）
- 按用户分表（大用户数据隔离）

### 8.2 扩展性设计

#### 8.2.1 水平扩展

**无状态服务：**
- Workflow Service、Node Service 等设计为无状态
- 可以水平扩展多个实例
- 通过负载均衡分发请求

**有状态服务：**
- Scheduler Service 需要单实例或主从模式
- 使用分布式锁保证任务不重复执行

#### 8.2.2 插件化架构

**节点插件：**
- 支持自定义节点类型
- 节点插件动态加载
- 插件隔离执行

**AI 模型插件：**
- 支持新的 AI 模型接入
- 通过适配器模式统一接口
- 插件配置化管理

---

## 九、安全性和权限控制

### 9.1 工作流权限

#### 9.1.1 访问控制

**工作流级别权限：**
- 所有者：完全控制
- 编辑者：可以编辑和运行
- 查看者：只能查看
- 执行者：只能运行

**资源隔离：**
- 用户只能访问自己有权限的工作流
- 数据库查询自动过滤
- API 层面验证权限

#### 9.1.2 执行权限

**执行限制：**
- 用户只能执行自己有权限的工作流
- 支持执行配额限制
- 支持执行时间限制

**资源配额：**
- 每个用户的工作流数量限制
- 每个工作流的执行次数限制
- 每个工作流的执行时长限制

### 9.2 数据安全

#### 9.2.1 数据加密

**传输加密：**
- 所有服务间通信使用 TLS
- Gateway 到前端使用 HTTPS

**存储加密：**
- 敏感数据（如 API Key）加密存储
- 使用 AES 加密算法

#### 9.2.2 数据隔离

**多租户隔离：**
- 用户数据完全隔离
- 数据库层面隔离（分库或分表）
- 缓存层面隔离（Key 前缀）

---

## 十、监控和运维

### 10.1 监控指标

#### 10.1.1 业务指标

**工作流指标：**
- 工作流总数
- 活跃工作流数
- 工作流执行次数
- 工作流成功率
- 平均执行时长

**执行指标：**
- 当前执行中的工作流数
- 执行队列长度
- 执行失败率
- 节点执行耗时分布

#### 10.1.2 系统指标

**服务指标：**
- 服务 QPS
- 服务响应时间
- 服务错误率
- 服务健康状态

**资源指标：**
- CPU 使用率
- 内存使用率
- 数据库连接数
- 消息队列长度

### 10.2 日志和追踪

#### 10.2.1 日志系统

**日志级别：**
- DEBUG：详细调试信息
- INFO：一般信息
- WARN：警告信息
- ERROR：错误信息

**日志内容：**
- 工作流执行日志
- 节点执行日志
- 系统操作日志
- 错误堆栈信息

#### 10.2.2 分布式追踪

**追踪ID：**
- 每个请求分配唯一追踪ID
- 在服务间传递追踪ID
- 用于关联日志和追踪

**追踪内容：**
- 请求路径
- 服务调用链
- 执行耗时
- 错误信息

---

**第三部分结束，总结部分...**

