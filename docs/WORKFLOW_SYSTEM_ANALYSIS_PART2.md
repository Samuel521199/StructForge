# StructForge 工作流系统架构分析 - 第二部分

## 三、工作流执行引擎设计

### 3.1 执行引擎架构

#### 3.1.1 执行流程

```
用户触发执行
    ↓
Workflow Service 创建执行实例
    ↓
执行引擎解析工作流定义
    ↓
构建执行图（DAG）
    ↓
按拓扑顺序执行节点
    ↓
每个节点调用 Node Service
    ↓
收集节点执行结果
    ↓
更新执行状态
    ↓
完成执行
```

#### 3.1.2 执行模式

**同步执行：**
- 适用于简单工作流
- 用户等待执行完成
- 返回执行结果

**异步执行：**
- 适用于长时间运行的工作流
- 立即返回执行ID
- 通过 WebSocket 推送执行状态

**定时执行：**
- 由 Scheduler Service 触发
- 按 Cron 表达式执行
- 支持一次性、周期性执行

### 3.2 多工作流并发管理

#### 3.2.1 执行队列设计

**队列结构：**
```
┌─────────────────────────────────────────────────────────────┐
│  执行队列管理器                                               │
├─────────────────────────────────────────────────────────────┤
│  高优先级队列（手动触发、API触发）                            │
│  ┌─────┐ ┌─────┐ ┌─────┐                                   │
│  │执行1│ │执行2│ │执行3│ ...                                │
│  └─────┘ └─────┘ └─────┘                                   │
├─────────────────────────────────────────────────────────────┤
│  普通队列（定时触发、Webhook触发）                            │
│  ┌─────┐ ┌─────┐ ┌─────┐                                   │
│  │执行4│ │执行5│ │执行6│ ...                                │
│  └─────┘ └─────┘ └─────┘                                   │
└─────────────────────────────────────────────────────────────┘
```

**队列实现：**
- 使用 Redis 作为队列存储
- 支持优先级队列
- 支持延迟执行
- 支持任务重试

#### 3.2.2 并发控制

**工作流级别并发：**
- 每个工作流可以设置最大并发执行数
- 超过限制的执行请求进入队列等待

**系统级别并发：**
- 全局最大并发执行数限制
- 防止系统过载

**资源隔离：**
- 每个用户的工作流执行相互隔离
- 支持资源配额管理

### 3.3 执行状态管理

#### 3.3.1 状态流转

```
pending → running → success
                ↓
            failed
                ↓
            cancelled
```

**状态说明：**
- `pending`：等待执行
- `running`：正在执行
- `success`：执行成功
- `failed`：执行失败
- `cancelled`：已取消

#### 3.3.2 状态持久化

- 使用 PostgreSQL 存储执行状态
- 使用 Redis 缓存当前执行状态
- 定期同步状态到数据库

---

## 四、Scheduler Service（调度服务）设计

### 4.1 核心职责

**定时任务管理：**
- 定时任务的 CRUD 操作
- Cron 表达式解析和验证
- 任务调度和执行

**任务队列管理：**
- 任务队列维护
- 任务优先级管理
- 任务重试机制

### 4.2 定时任务设计

#### 4.2.1 任务类型

**一次性任务：**
- 在指定时间执行一次
- 执行后自动删除

**周期性任务：**
- 按 Cron 表达式周期性执行
- 支持秒级、分钟级、小时级、天级、周级、月级

**延迟任务：**
- 延迟指定时间后执行
- 支持固定延迟和指数退避

#### 4.2.2 任务模型

```go
type ScheduledTask struct {
    ID          string    // 任务ID
    WorkflowID  string    // 工作流ID
    UserID      string    // 用户ID
    CronExpr    string    // Cron 表达式
    Timezone    string    // 时区
    Enabled     bool      // 是否启用
    NextRunTime time.Time // 下次执行时间
    LastRunTime *time.Time // 上次执行时间
    RunCount    int       // 执行次数
    MaxRuns     int       // 最大执行次数（0表示无限制）
    CreatedAt   time.Time
    UpdatedAt   time.Time
}
```

#### 4.2.3 调度算法

**时间轮算法：**
- 使用时间轮实现高效的任务调度
- 支持秒级精度
- 支持大量任务调度

**任务分发：**
- Scheduler Service 负责任务调度
- 实际执行由 Workflow Service 处理
- 通过消息队列解耦

### 4.3 与 Workflow Service 的交互

```
Scheduler Service
    ↓ (定时触发)
创建执行任务
    ↓
发送到消息队列
    ↓
Workflow Service 接收任务
    ↓
执行工作流
    ↓
返回执行结果
```

---

## 五、用户多工作流管理设计

### 5.1 用户工作流组织

#### 5.1.1 工作流分组

**文件夹结构：**
```
用户工作空间
├── 我的工作流
│   ├── 数据处理
│   ├── API 集成
│   └── AI 工作流
├── 共享工作流（其他用户分享的）
└── 模板工作流（系统模板）
```

**标签系统：**
- 每个工作流可以有多个标签
- 支持按标签筛选和分组
- 支持自定义标签

#### 5.1.2 工作流权限管理

**权限级别：**
- `owner`：所有者（创建者）
- `editor`：编辑者（可以编辑和运行）
- `viewer`：查看者（只能查看）
- `executor`：执行者（只能运行，不能编辑）

**共享机制：**
- 工作流可以分享给其他用户
- 支持设置分享权限
- 支持分享链接（带权限控制）

### 5.2 工作流版本控制

#### 5.2.1 版本管理

**版本策略：**
- 每次保存创建新版本
- 保留历史版本（可配置保留数量）
- 支持版本回滚
- 支持版本对比

**版本模型：**
```go
type WorkflowVersion struct {
    ID          string    // 版本ID
    WorkflowID  string    // 工作流ID
    Version     int       // 版本号
    Definition  string    // 工作流定义
    Changelog   string    // 变更日志
    CreatedBy   string    // 创建者
    CreatedAt   time.Time
}
```

#### 5.2.2 版本操作

- **创建版本**：保存时自动创建
- **查看历史版本**：查看所有历史版本
- **回滚版本**：恢复到指定版本
- **版本对比**：对比两个版本的差异
- **发布版本**：将某个版本标记为正式版本

### 5.3 工作流模板系统

#### 5.3.1 模板分类

**系统模板：**
- 由平台提供的预设模板
- 涵盖常见场景
- 用户可以直接使用

**用户模板：**
- 用户自己创建和保存的模板
- 可以分享给其他用户
- 支持模板市场

#### 5.3.2 模板使用流程

```
1. 用户浏览模板库
   ↓
2. 选择模板
   ↓
3. 基于模板创建工作流
   ↓
4. 自定义工作流内容
   ↓
5. 保存为新工作流
```

---

**第二部分结束，继续第三部分...**

