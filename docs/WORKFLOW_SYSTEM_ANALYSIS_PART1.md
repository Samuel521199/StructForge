# StructForge 工作流系统架构分析 - 第一部分

## 一、前端界面分析与改进建议

### 1.1 仪表盘（Dashboard）功能完善

#### 当前状态
- ✅ 已有统计卡片（运行中、排队、总执行次数、失败率）
- ✅ 已有执行历史列表
- ✅ 已有成功率统计表格
- ✅ 已有图表展示（错误趋势、执行时长）
- ❌ **缺少创建新工作流的快捷按钮**

#### 改进建议

**1.1.1 仪表盘头部区域增强**

```
┌─────────────────────────────────────────────────────────────┐
│  仪表盘                                    [刷新] [创建工作流] │
└─────────────────────────────────────────────────────────────┘
```

**功能布局：**
- **左侧**：页面标题 "仪表盘"
- **右侧**：操作按钮组
  - `刷新` 按钮（已有）
  - `创建新工作流` 按钮（新增，主要操作，突出显示）
  - `导入工作流` 按钮（可选）
  - `工作流模板` 按钮（可选）

**按钮设计：**
- `创建新工作流` 按钮：
  - 类型：`primary`，大尺寸
  - 图标：`Plus` 或 `DocumentAdd`
  - 点击行为：跳转到 `/workflow/editor`（新建模式）
  - 位置：右上角，与刷新按钮并排

**1.1.2 快速操作卡片区域（新增）**

在统计卡片下方，添加快速操作区域：

```
┌─────────────────────────────────────────────────────────────┐
│  快速操作                                                    │
├─────────────────────────────────────────────────────────────┤
│  [创建新工作流]  [从模板创建]  [导入工作流]  [查看所有工作流] │
└─────────────────────────────────────────────────────────────┘
```

**卡片内容：**
- **创建新工作流**：空白画布，从头开始设计
- **从模板创建**：选择预设模板（如：数据处理流程、API 集成流程等）
- **导入工作流**：从 JSON 文件导入工作流定义
- **查看所有工作流**：跳转到工作流列表页面

**1.1.3 最近工作流快捷入口（新增）**

在主要内容区域上方，添加最近访问的工作流：

```
┌─────────────────────────────────────────────────────────────┐
│  最近工作流                          [查看全部]              │
├─────────────────────────────────────────────────────────────┤
│  [工作流A] [工作流B] [工作流C] ...                           │
│  最后编辑：2小时前    最后编辑：1天前    最后编辑：3天前      │
└─────────────────────────────────────────────────────────────┘
```

---

### 1.2 工作流列表页面（WorkflowList）功能分析

#### 当前功能
- ✅ 工作流列表展示
- ✅ 搜索和筛选
- ✅ 分页
- ✅ 创建按钮（在列表头部）
- ✅ 编辑、删除操作

#### 功能布局优化建议

**1.2.1 页面布局结构**

```
┌─────────────────────────────────────────────────────────────┐
│  工作流管理                                    [创建新工作流] │
├─────────────────────────────────────────────────────────────┤
│  [搜索框] [状态筛选] [标签筛选] [排序] [视图切换]           │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │  工作流列表（表格视图/卡片视图）                      │   │
│  │                                                      │   │
│  │  [工作流卡片/表格行]                                  │   │
│  │  - 工作流名称                                        │   │
│  │  - 状态标签                                          │   │
│  │  - 最后执行时间                                      │   │
│  │  - 执行次数统计                                      │   │
│  │  - 操作按钮（运行/编辑/复制/删除）                    │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  [分页控件]                                                 │
└─────────────────────────────────────────────────────────────┘
```

**1.2.2 视图切换功能**

支持两种视图模式：
- **表格视图**（当前）：适合快速浏览和批量操作
- **卡片视图**（新增）：适合可视化展示，每个工作流显示为卡片
  - 卡片内容：
    - 工作流缩略图（工作流图的简化预览）
    - 工作流名称和描述
    - 状态标签
    - 统计信息（执行次数、成功率）
    - 快速操作按钮

**1.2.3 批量操作功能（新增）**

- 多选工作流
- 批量操作：
  - 批量运行
  - 批量停止
  - 批量删除
  - 批量导出
  - 批量设置标签

**1.2.4 高级筛选（增强）**

- 按状态筛选：运行中、已停止、已暂停、错误
- 按标签筛选：自定义标签
- 按创建时间筛选：今天、本周、本月、自定义范围
- 按执行次数筛选：最活跃、最少使用
- 按成功率筛选：高成功率、低成功率

---

### 1.3 工作流编辑器页面（WorkflowEditor）功能分析

#### 当前功能
- ✅ 节点面板（NodePalette）
- ✅ 画布区域（WorkflowEditor）
- ✅ 属性面板（节点属性编辑）
- ✅ 工具栏（保存、运行）

#### 功能布局优化建议

**1.3.1 完整布局结构**

```
┌─────────────────────────────────────────────────────────────┐
│  [返回] 工作流名称                    [保存] [运行] [设置]   │
├──────────┬──────────────────────────────────────┬───────────┤
│          │                                      │           │
│  节点面板 │          画布区域                    │  属性面板 │
│          │      (工作流可视化编辑)               │           │
│  - 触发  │                                      │  - 节点   │
│  - AI    │      [节点] → [节点] → [节点]        │   属性    │
│  - 数据  │                                      │  - 工作流 │
│  - 集成  │                                      │   属性    │
│  - 控制  │                                      │  - 变量  │
│  - 工具  │                                      │           │
│          │                                      │           │
├──────────┴──────────────────────────────────────┴───────────┤
│  执行日志/调试面板（可折叠）                                 │
└─────────────────────────────────────────────────────────────┘
```

**1.3.2 工具栏增强**

- **左侧工具栏**：
  - 返回按钮
  - 工作流名称（可编辑）
  - 工作流状态指示器
  - 未保存提示（*）

- **右侧工具栏**：
  - `保存` 按钮
  - `运行` 按钮（下拉菜单：立即运行、测试运行、定时运行）
  - `设置` 按钮（工作流设置：名称、描述、标签、变量、环境变量）
  - `导出` 按钮（导出为 JSON）
  - `导入` 按钮（从 JSON 导入）
  - `撤销/重做` 按钮
  - `缩放控制`（放大、缩小、适应画布）

**1.3.3 节点面板增强**

- **分类展示**：
  - 触发节点（Webhook、定时器、手动触发）
  - AI 节点（文本生成、图像生成、对话）
  - 数据处理节点（转换、过滤、聚合、映射、排序）
  - 集成节点（HTTP、数据库、消息队列、邮件、Webhook）
  - 控制节点（条件、循环、并行、分支、延迟）
  - 工具节点（脚本、文件操作、系统命令）

- **搜索功能**：快速搜索节点类型
- **节点详情**：悬停显示节点说明和参数

**1.3.4 画布区域增强**

- **网格背景**：对齐辅助
- **小地图**：显示整个工作流的缩略图
- **缩放控制**：鼠标滚轮缩放，拖拽平移
- **节点连接**：拖拽连接线，自动对齐
- **节点选择**：单选、多选、框选
- **快捷键支持**：
  - `Ctrl+S`：保存
  - `Ctrl+Z`：撤销
  - `Ctrl+Y`：重做
  - `Delete`：删除选中节点
  - `Ctrl+C`：复制
  - `Ctrl+V`：粘贴
  - `Ctrl+F`：搜索节点

**1.3.5 属性面板增强**

- **工作流属性**：
  - 基本信息（名称、描述、标签）
  - 变量定义（全局变量）
  - 环境变量
  - 执行设置（超时时间、重试策略）
  - 通知设置（执行成功/失败通知）

- **节点属性**：
  - 节点基本信息
  - 节点特定参数
  - 输入/输出映射
  - 错误处理策略
  - 节点执行条件

**1.3.6 调试面板（新增）**

- **执行日志**：实时显示执行日志
- **变量查看器**：查看当前执行上下文中的变量值
- **断点调试**：在节点上设置断点，暂停执行
- **单步执行**：逐步执行工作流

---

## 二、后端微服务架构设计

### 2.1 微服务划分原则

根据业务领域和职责，将系统划分为以下微服务：

```
┌─────────────────────────────────────────────────────────────┐
│                    Gateway (API Gateway)                     │
│              统一入口、路由、认证、限流                       │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        ▼                   ▼                   ▼
┌──────────────┐  ┌────────────────┐  ┌──────────────┐
│ User Service │  │Workflow Service│  │  AI Service  │
│   用户管理    │  │   工作流管理    │  │   AI模型调用  │
└──────────────┘  └────────────────┘  └──────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        ▼                   ▼                   ▼
┌──────────────┐  ┌────────────────┐  ┌──────────────┐
│ Node Service │  │ Scheduler      │  │  Tool Service│
│   节点管理    │  │   定时调度      │  │   工具集成    │
└──────────────┘  └────────────────┘  └──────────────┘
                            │
                            ▼
                   ┌────────────────┐
                   │   Log Service  │
                   │     日志服务    │
                   └────────────────┘
```

---

### 2.2 Workflow Service（工作流服务）设计

#### 2.2.1 核心职责

**工作流定义管理：**
- 工作流的 CRUD 操作
- 工作流版本控制
- 工作流模板管理
- 工作流导入/导出

**工作流执行管理：**
- 创建工作流执行实例
- 执行状态管理
- 执行历史查询
- 执行结果存储

**工作流调度：**
- 接收执行请求
- 创建工作流执行任务
- 与 Scheduler Service 协调定时任务

#### 2.2.2 数据模型设计

**Workflow（工作流定义）**
```go
type Workflow struct {
    ID          string    // 工作流ID
    UserID      string    // 创建用户ID
    Name        string    // 工作流名称
    Description string    // 描述
    Version     int       // 版本号
    Status      string    // 状态：draft, active, paused, archived
    Definition  string    // 工作流定义（JSON）
    Nodes       []Node    // 节点列表
    Edges       []Edge    // 连接关系
    Variables   []Variable // 全局变量
    Settings    Settings  // 工作流设置
    Tags        []string  // 标签
    CreatedAt   time.Time
    UpdatedAt   time.Time
}
```

**WorkflowExecution（工作流执行实例）**
```go
type WorkflowExecution struct {
    ID          string    // 执行ID
    WorkflowID  string    // 工作流ID
    UserID      string    // 执行用户ID
    Status      string    // 状态：pending, running, success, failed, cancelled
    TriggerType string    // 触发类型：manual, scheduled, webhook, api
    InputData   map[string]interface{} // 输入数据
    OutputData  map[string]interface{} // 输出数据
    StartTime   time.Time
    EndTime     *time.Time
    Duration    int64     // 执行时长（毫秒）
    Error       string    // 错误信息
    NodeExecutions []NodeExecution // 节点执行记录
    CreatedAt   time.Time
}
```

#### 2.2.3 API 设计

**工作流定义 API：**
```
POST   /api/v1/workflows              - 创建工作流
GET    /api/v1/workflows              - 获取工作流列表
GET    /api/v1/workflows/:id          - 获取工作流详情
PUT    /api/v1/workflows/:id          - 更新工作流
DELETE /api/v1/workflows/:id          - 删除工作流
POST   /api/v1/workflows/:id/duplicate - 复制工作流
POST   /api/v1/workflows/:id/export   - 导出工作流
POST   /api/v1/workflows/import       - 导入工作流
```

**工作流执行 API：**
```
POST   /api/v1/workflows/:id/execute  - 执行工作流
GET    /api/v1/workflows/:id/executions - 获取执行历史
GET    /api/v1/executions/:id         - 获取执行详情
POST   /api/v1/executions/:id/cancel  - 取消执行
GET    /api/v1/executions/:id/logs    - 获取执行日志
```

---

### 2.3 Node Service（节点服务）设计

#### 2.3.1 核心职责

**节点类型管理：**
- 节点类型注册
- 节点元数据管理（名称、描述、参数定义）
- 节点验证规则

**节点执行：**
- 接收节点执行请求
- 调用相应的节点执行器
- 返回执行结果

**节点插件系统：**
- 支持自定义节点类型
- 节点插件加载和管理

#### 2.3.2 节点分类

**触发节点（Trigger Nodes）：**
- `webhook`：接收 HTTP 请求
- `timer`：定时触发
- `manual`：手动触发
- `event`：事件触发

**AI 节点（AI Nodes）：**
- `text_generation`：文本生成
- `image_generation`：图像生成
- `chat`：对话
- `embedding`：向量化

**数据处理节点（Data Nodes）：**
- `transform`：数据转换
- `filter`：数据过滤
- `aggregate`：数据聚合
- `map`：数据映射
- `sort`：数据排序

**集成节点（Integration Nodes）：**
- `http`：HTTP 请求
- `database`：数据库操作
- `message_queue`：消息队列
- `email`：邮件发送
- `webhook`：Webhook 发送

**控制节点（Control Nodes）：**
- `condition`：条件判断
- `loop`：循环
- `parallel`：并行执行
- `switch`：分支选择
- `delay`：延迟

**工具节点（Tool Nodes）：**
- `script`：脚本执行
- `file_operation`：文件操作
- `system_command`：系统命令

#### 2.3.3 节点执行流程

```
1. Workflow Service 发送节点执行请求
   ↓
2. Node Service 接收请求
   ↓
3. 根据节点类型，查找对应的执行器
   ↓
4. 验证节点参数
   ↓
5. 执行节点逻辑
   ↓
6. 返回执行结果
   ↓
7. Workflow Service 继续执行下一个节点
```

---

**第一部分结束，继续第二部分...**

